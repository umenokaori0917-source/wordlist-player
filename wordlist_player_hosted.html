<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>単語リストプレイヤー（速度・連続・お気に入り・A-B・ホスティング対応）</title>
<style>
  :root { --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans Thai", sans-serif; margin: 16px; }
  header { display: grid; gap: 10px; margin-bottom: 16px; }
  h1 { font-size: 1.15rem; margin: 0; }
  .tip { color:#555; font-size: .9rem; line-height:1.4; }
  .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  input[type="search"]{ flex:1 1 240px; padding:10px 12px; border:1px solid #ddd; border-radius: var(--radius); }
  button, .btn { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius: var(--radius); cursor:pointer; }
  button:hover, .btn:hover { background:#f5f5f5; }
  select, .select { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius: var(--radius); }
  .pill { font-size:.75rem; color:#666; border:1px solid #e5e5e5; padding:2px 6px; border-radius:999px;}
  .list { display:grid; gap: var(--gap); }
  .card { border:1px solid #eee; border-radius: var(--radius); padding: 10px 12px; display:grid; gap:8px; }
  .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
  .th { font-size: 1.15rem; font-weight: 600; display:flex; align-items:center; gap:8px; }
  .rom { color:#333; font-family: ui-monospace, Menlo, Consolas, monospace; }
  .jp { color:#666; }
  .actions { display:flex; align-items:center; gap:8px; }
  .fav { border:none; background:transparent; font-size: 1.1rem; padding:4px 6px; cursor:pointer; }
  .fav[aria-pressed="true"]{ color:#e39; }
  .progress-wrap{ display:flex; align-items:center; gap:6px; }
  .progress{ height:6px; background:#eee; border-radius:999px; overflow:hidden; width:140px; }
  .bar{ height:100%; width:0%; background:#999; }
  .muted { color:#999; }
  .small { font-size:.82rem; }
  .hidden { display:none; }
  .speed { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .speed input[type="range"]{ width: 200px; }
  .seq { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .sep { color:#bbb; }
  .nowplaying { font-weight:600; }
  .ab { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px; }
</style>
</head>
<body>
  <header>
    <h1>単語リストプレイヤー（速度・連続・お気に入り・A-B・ホスティング対応）</h1>
    <div class="tip small">
      オーディオの配置先を <code>BASE_URL</code> で指定できます。<br>
      例）<code>BASE_URL = "./audio/"</code> とすれば、<code>audio/ファイル名</code> を参照します。<br>
      URLクエリでも指定可：<code>?base=https://example.com/audio/</code>
    </div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="検索：タイ語 / ローマ字 / 日本語 で絞り込み">
      <button id="clearBtn" title="検索をクリア">クリア</button>
      <span class="small muted">（iOS/Androidは初回タップ後に音が出ます）</span>
    </div>
    <div class="speed">
      <strong>再生速度</strong>
      <button id="minusBtn" aria-label="速度を0.1下げる">−</button>
      <input id="rate" type="range" min="0.5" max="2.0" step="0.1" value="1.0" aria-label="再生速度スライダー">
      <button id="plusBtn" aria-label="速度を0.1上げる">＋</button>
      <span id="rateLabel" class="pill">1.0×</span>
      <span class="sep">|</span>
      <div class="seq">
        <strong>連続再生</strong>
        <select id="seqMode" class="select" title="再生対象">
          <option value="all">一覧（全体）</option>
          <option value="favs">お気に入りのみ</option>
        </select>
        <label class="small"><input id="loopOne" type="checkbox"> 1語ループ</label>
        <button id="seqStart" class="btn">▶ 連続再生開始</button>
        <button id="seqStop" class="btn">■ 停止</button>
        <span id="np" class="small muted"></span>
      </div>
      <div class="ab">
        <strong>A-B区間</strong>
        <button id="setA" class="btn">A設定</button>
        <button id="setB" class="btn">B設定</button>
        <label class="small"><input id="abEnable" type="checkbox"> A-B有効</label>
        <button id="abClear" class="btn">クリア</button>
        <span class="pill small">A: <span id="aLabel">–:––</span></span>
        <span class="pill small">B: <span id="bLabel">–:––</span></span>
      </div>
    </div>
  </header>

  <section class="list" id="list"></section>

  <div class="small muted" style="margin-top:10px">※ ローマ字は声調付き（例：<code>sà-wàt-dii</code>）。正確な表記を併記。お気に入り・A-Bは端末内に保存。</div>

  <audio id="player" preload="none" crossOrigin="anonymous"></audio>

<script>
let BASE_URL = "./audio/";
try { const u=new URL(location.href); const b=u.searchParams.get('base'); if(b) BASE_URL=b; } catch(e){}

const ITEMS = [
  { id:"th-001", th:"สวัสดี", rom:"sà-wàt-dii", jp:"こんにちは", file:["th-001-sawatdee.mp3"] },
  { id:"th-002", th:"ขอบคุณ", rom:"khɔ̀ɔp-khun", jp:"ありがとう", file:["th-002-khopkhun.mp3"] },
  { id:"th-003", th:"ขอโทษ", rom:"khǎaw-thôot", jp:"ごめんなさい", file:["th-003-khothot.mp3"] },
  { id:"th-004", th:"ใช่", rom:"châi", jp:"はい（そうです）", file:["th-004-chai.mp3"] },
  { id:"th-005", th:"ไม่ใช่", rom:"mâi châi", jp:"いいえ（違います）", file:["th-005-mai-chai.mp3"] },
  { id:"th-006", th:"ราคาเท่าไหร่", rom:"raa-khaa thâo-rài", jp:"いくらですか", file:["th-006-rakhaa-thaorai.mp3"] },
  { id:"th-007", th:"ห้องน้ำอยู่ที่ไหน", rom:"hɔ̂ŋ-náam yùu thîi-nǎi", jp:"トイレはどこですか", file:["th-007-hongnam-yu-thi-nai.mp3"] },
  { id:"th-008", th:"ฉันชื่อ...", rom:"chǎn chʉ̂ʉ ...", jp:"私の名前は…です（女性）", file:["th-008-chan-chue.mp3"] },
  { id:"th-009", th:"ผมชื่อ...", rom:"phǒm chʉ̂ʉ ...", jp:"僕の名前は…です（男性）", file:["th-009-phom-chue.mp3"] },
  { id:"th-010", th:"ฉันเป็นคนญี่ปุ่น", rom:"chǎn pen khon yîi-pùn", jp:"私は日本人です", file:["th-010-chan-pen-khon-yipun.mp3"] },
  { id:"th-011", th:"ฉันเป็นนักศึกษามหาวิทยาลัยปีที่สาม", rom:"chǎn pen nák-sʉ̀k-sǎa má-hǎa-wít-tha-yaa-lai pii-thîi-sǎam", jp:"私は大学3年生です", file:["th-011-chan-naksueksa-pi3.mp3"] },
  { id:"th-012", th:"ฉันชอบอ่านหนังสือและเรียนภาษาต่างประเทศ", rom:"chǎn chɔ̂ɔp àan năng-sʉ̌ʉ lɛ́ rian phaa-sǎa tàang-prathêet", jp:"私は読書と外国語学習が好きです", file:["th-012-chan-chop-aan-rian-pasa.mp3"] }
];

const list=document.getElementById('list'), q=document.getElementById('q'), clearBtn=document.getElementById('clearBtn');
const player=document.getElementById('player'), rate=document.getElementById('rate'), rateLabel=document.getElementById('rateLabel');
const minusBtn=document.getElementById('minusBtn'), plusBtn=document.getElementById('plusBtn');
const seqMode=document.getElementById('seqMode'), loopOne=document.getElementById('loopOne');
const seqStart=document.getElementById('seqStart'), seqStop=document.getElementById('seqStop'), np=document.getElementById('np');
const setA=document.getElementById('setA'), setB=document.getElementById('setB'), abEnable=document.getElementById('abEnable'), abClear=document.getElementById('abClear');
const aLabel=document.getElementById('aLabel'), bLabel=document.getElementById('bLabel');

let currentId=null, progressTimer=null, isContinuous=false, queue=[], queueIndex=-1;

function secondsToMMSS(sec){ if(!isFinite(sec)) return '–:––'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return m+':'+String(s).padStart(2,'0'); }
function roundRate(x){ const v=Math.round(x*10)/10; return Math.min(2.0, Math.max(0.5, v)); }
function applyRate(v){ const r=roundRate(v); player.playbackRate=r; rate.value=r.toFixed(1); rateLabel.textContent=r.toFixed(1)+'×'; localStorage.setItem('playerRate', r.toFixed(1)); }
function getFavs(){ try{return JSON.parse(localStorage.getItem('favs')||'[]')}catch(e){return []} }
function setFavs(arr){ localStorage.setItem('favs', JSON.stringify(arr)); }
function isFav(id){ return getFavs().includes(id); }
function toggleFav(id){ const arr=getFavs(); const i=arr.indexOf(id); if(i>=0) arr.splice(i,1); else arr.push(id); setFavs(arr); }

function loadABMap(){ try{return JSON.parse(localStorage.getItem('abMap')||'{}')}catch(e){return {}} }
function saveABMap(m){ localStorage.setItem('abMap', JSON.stringify(m)); }
function getAB(id){ const m=loadABMap(); return m[id]||{a:null,b:null,enabled:false}; }
function setAB(id,o){ const m=loadABMap(); m[id]=o; saveABMap(m); }
function updateABUI(id){ const {a,b,enabled}=getAB(id); aLabel.textContent=a==null?'–:––':secondsToMMSS(a); bLabel.textContent=b==null?'–:––':secondsToMMSS(b); abEnable.checked=!!enabled; }

function render(items){
  list.innerHTML='';
  items.forEach(item=>{
    const card=document.createElement('div'); card.className='card'; card.dataset.id=item.id;
    const row1=document.createElement('div'); row1.className='row';
    const th=document.createElement('div'); th.className='th';
    const favBtn=document.createElement('button'); favBtn.className='fav'; const favOn=isFav(item.id);
    favBtn.setAttribute('aria-pressed', favOn?'true':'false'); favBtn.textContent=favOn?'★':'☆'; favBtn.title='お気に入りに追加/解除';
    favBtn.addEventListener('click', ()=>{ toggleFav(item.id); const on=isFav(item.id); favBtn.setAttribute('aria-pressed', on?'true':'false'); favBtn.textContent=on?'★':'☆'; if(isContinuous&&seqMode.value==='favs') buildQueue(); });

    const thText=document.createElement('span'); thText.textContent=item.th;
    th.appendChild(favBtn); th.appendChild(thText);

    const actions=document.createElement('div'); actions.className='actions';
    const playBtn=document.createElement('button'); playBtn.className='btn'; playBtn.textContent='▶ 再生';
    playBtn.addEventListener('click', ()=>togglePlay(item));
    const filePill=document.createElement('span'); filePill.className='pill'; filePill.textContent=Array.isArray(item.file)?item.file[0]:item.file;
    actions.appendChild(playBtn); actions.appendChild(filePill);

    row1.appendChild(th); row1.appendChild(actions);

    const rom=document.createElement('div'); rom.className='rom'; rom.textContent=item.rom;
    const jp=document.createElement('div'); jp.className='jp'; jp.textContent=item.jp;

    const progWrap=document.createElement('div'); progWrap.className='progress-wrap hidden';
    const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('div'); bar.className='bar'; prog.appendChild(bar);
    const timeLabel=document.createElement('span'); timeLabel.className='small muted'; timeLabel.textContent='0:00';
    progWrap.appendChild(prog); progWrap.appendChild(timeLabel);

    const cardEl=card;
    cardEl.appendChild(row1); cardEl.appendChild(rom); cardEl.appendChild(jp); cardEl.appendChild(progWrap); list.appendChild(cardEl);

    item._els={ playBtn, progWrap, bar, timeLabel, thText };
  });
  updateNowPlayingStyle();
}

function setAllButtonsToPlay(){ ITEMS.forEach(it=>{ if(it._els) it._els.playBtn.textContent='▶ 再生'; }); }
function updateNowPlayingStyle(){ ITEMS.forEach(it=>{ if(!it._els) return; it._els.thText.classList.toggle('nowplaying', it.id===currentId && !player.paused); }); }
function updateProgressUI(item){ if(!item||!item._els) return; const {bar,timeLabel}=item._els; const dur=player.duration||0, cur=player.currentTime||0; const pct=dur?Math.min(100, Math.max(0,(cur/dur)*100)):0; bar.style.width=pct+'%'; timeLabel.textContent=secondsToMMSS(cur)+(dur?' / '+secondsToMMSS(dur):''); }
function startProgress(item){ if(!item||!item._els) return; item._els.progWrap.classList.remove('hidden'); stopProgress(); progressTimer=setInterval(()=>updateProgressUI(item),200); }
function stopProgress(){ if(progressTimer) clearInterval(progressTimer); progressTimer=null; }
function pickSrc(file){ return BASE_URL + (Array.isArray(file)?file[0]:file); }

function playItem(item){
  player.src=pickSrc(item.file);
  player.play().then(()=>{
    currentId=item.id;
    setAllButtonsToPlay();
    item._els.playBtn.textContent='⏸ 停止';
    startProgress(item);
    updateNowPlayingStyle();
    np.textContent='Now Playing: '+item.th+' ('+item.jp+')';
    updateABUI(item.id);
  }).catch(err=>{
    alert('音声を再生できませんでした。ファイルURLやCORSを確認してください。\n'+err);
  });
}

function togglePlay(item){
  if(currentId===item.id && !player.paused){
    player.pause(); player.currentTime=0; player.dispatchEvent(new Event('ended'));
    return;
  }
  if(isContinuous){
    const ix=queue.findIndex(x=>x.id===item.id);
    if(ix>=0) queueIndex=ix;
    else { seqMode.value='all'; buildQueue(); queueIndex=queue.findIndex(x=>x.id===item.id); }
  }
  playItem(item);
}

player.addEventListener('timeupdate', ()=>{
  if(!currentId) return;
  const ab=getAB(currentId);
  if(!ab.enabled||ab.a==null||ab.b==null) return;
  const cur=player.currentTime||0; const eps=0.02;
  if(cur>=ab.b-eps){
    player.currentTime=ab.a;
    if(player.paused) player.play().catch(()=>{});
  }
});

player.addEventListener('ended', ()=>{
  const item=ITEMS.find(it=>it.id===currentId);
  if(item&&item._els){
    item._els.playBtn.textContent='▶ 再生';
    item._els.progWrap.classList.add('hidden');
    item._els.bar.style.width='0%';
    item._els.timeLabel.textContent='0:00';
  }
  stopProgress();
  updateNowPlayingStyle();

  const ab=currentId?getAB(currentId):{enabled:false};
  if(ab.enabled&&ab.a!=null&&ab.b!=null){
    player.currentTime=ab.a;
    player.play().catch(()=>{});
    return;
  }

  if(!isContinuous){ currentId=null; np.textContent=''; return; }
  if(loopOne.checked){ playItem(item); return; }

  queueIndex++;
  if(queueIndex>=queue.length){ stopContinuous(); return; }
  playItem(queue[queueIndex]);
});

function buildQueue(){
  if(seqMode.value==='favs'){
    const favIds=new Set(getFavs());
    queue=ITEMS.filter(it=>favIds.has(it.id));
  } else {
    queue=ITEMS.slice();
  }
}
function startContinuous(){
  buildQueue();
  if(!queue.length){
    alert(seqMode.value==='favs'?'お気に入りが空です。☆をつけてください。':'再生対象がありません。');
    return;
  }
  isContinuous=true;
  const ix=currentId?queue.findIndex(x=>x.id===currentId):-1;
  queueIndex=ix>=0?ix:0;
  playItem(queue[queueIndex]);
  seqStart.disabled=true;
  seqMode.disabled=true;
  loopOne.disabled=false;
}
function stopContinuous(){
  isContinuous=false;
  queue=[];
  queueIndex=-1;
  seqStart.disabled=false;
  seqMode.disabled=false;
  np.textContent='';
}
seqStart.addEventListener('click', startContinuous);
seqStop.addEventListener('click', ()=>{
  stopContinuous();
  if(!player.paused){
    player.pause(); player.currentTime=0; player.dispatchEvent(new Event('ended'));
  }
});

function doFilter(){
  const v=q.value.trim().toLowerCase();
  const filtered=ITEMS.filter(it=>it.th.toLowerCase().includes(v)||it.rom.toLowerCase().includes(v)||it.jp.toLowerCase().includes(v));
  render(filtered);
}
q.addEventListener('input', doFilter);
clearBtn.addEventListener('click', ()=>{ q.value=''; doFilter(); });

rate.addEventListener('input', e=>applyRate(parseFloat(e.target.value)));
minusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)-0.1));
plusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)+0.1));
(function initRate(){ const saved=parseFloat(localStorage.getItem('playerRate')||'1.0'); applyRate(saved); })();

render(ITEMS);
</script>
</body>
</html>
