<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>単語リストプレイヤー（A-B対応・TTSフォールバック・順序/ポーズカスタム）</title>
<style>
  :root { --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans Thai", sans-serif; margin: 16px; }
  header { display: grid; gap: 10px; margin-bottom: 16px; }
  h1 { font-size: 1.15rem; margin: 0; }
  .tip { color:#555; font-size:.9rem; line-height:1.4; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  input[type="search"]{ flex:1 1 240px; padding:10px 12px; border:1px solid #ddd; border-radius: 10px; }
  button, .btn { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius: 10px; cursor:pointer; }
  button:hover, .btn:hover { background:#f5f5f5; }
  select, .select, input[type="number"], input[type="text"] { padding:8px 10px; border:1px solid #ddd; border-radius:10px; }
  .pill { font-size:.75rem; color:#666; border:1px solid #e5e5e5; padding:2px 6px; border-radius:999px;}
  .list { display:grid; gap: 12px; }
  .card { border:1px solid #eee; border-radius: 10px; padding: 10px 12px; display:grid; gap:8px; }
  .head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .th { font-size: 1.15rem; font-weight:600; display:flex; align-items:center; gap:8px; }
  .rom { color:#333; font-family: ui-monospace, Menlo, Consolas, monospace; }
  .jp { color:#666; }
  .fav { border:none; background:transparent; font-size: 1.1rem; padding:4px 6px; cursor:pointer; }
  .fav[aria-pressed="true"]{ color:#e39; }
  .progress-wrap{ display:flex; align-items:center; gap:6px; }
  .progress{ height:6px; background:#eee; border-radius:999px; overflow:hidden; width:160px; }
  .bar{ height:100%; width:0%; background:#999; }
  .muted { color:#999; }
  .small { font-size:.82rem; }
  .hidden { display:none; }
  .nowplaying { font-weight:600; }
  .warn { color:#a33; }
  .group { display:grid; gap:8px; padding:10px; border:1px dashed #ddd; border-radius:10px; }
  .kv { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
</style>
</head>
<body>
<header>
  <h1>単語リストプレイヤー（A-B対応・TTSフォールバック・順序/ポーズカスタム）</h1>
  <div class="tip small">
    ファイルがある語は<strong>ファイル再生</strong>（A–B可）、無い語は<strong>TTS</strong>に自動フォールバック。<br>
    BASE_URL 既定: <code>./audio/</code>（?base=… で上書き可）
  </div>

  <!-- 検索・速度・連続再生 -->
  <div class="row">
    <input id="q" type="search" placeholder="検索：タイ語 / ローマ字 / 日本語 で絞り込み">
    <button id="clearBtn">クリア</button>

    <span>速度</span>
    <button id="minusBtn">−</button>
    <input id="rate" type="range" min="0.5" max="2.0" step="0.1" value="1.0" style="width:200px">
    <button id="plusBtn">＋</button>
    <span id="rateLabel" class="pill">1.0×</span>

    <span class="pill small">再生対象</span>
    <select id="seqMode">
      <option value="all">一覧（全体）</option>
      <option value="favs">お気に入りのみ</option>
    </select>
    <label class="small"><input id="loopOne" type="checkbox"> 1語ループ</label>
    <button id="seqStart">▶ 連続</button>
    <button id="seqStop">■ 停止</button>
    <span id="np" class="small muted"></span>
  </div>

  <!-- シーケンス設定 -->
  <div class="group">
    <div class="kv">
      <strong>シーケンス（1語あたりの流れ）</strong>
      <select id="seqPreset">
        <option value="th,jp">タイ語→日本語</option>
        <option value="jp,th">日本語→タイ語</option>
        <option value="th,pause,jp">タイ語→ポーズ→日本語</option>
        <option value="custom">カスタム</option>
      </select>
      <label class="small">カスタム: <input id="seqCustom" type="text" value="th,pause,jp" size="20"> <span class="muted small">（例: th,jp / jp,th / th,pause,jp など）</span></label>
      <label class="small">ポーズ秒: <input id="pauseSec" type="number" min="0" step="0.1" value="0.8" style="width:80px"></label>
    </div>
    <div class="kv">
      <span class="pill small">再生ソース</span>
      <label class="small"><input id="preferFileTh" type="checkbox" checked> タイ語はファイル優先（無ければTTS）</label>
      <label class="small"><input id="preferFileJp" type="checkbox"> 日本語もファイル優先（無ければTTS）</label>
      <span class="small muted">※ TTSはA–B不可。A–Bしたい語はファイルを用意してください。</span>
    </div>
  </div>
</header>

<section class="list" id="list"></section>
<h2 style="margin:14px 0 6px;">フレーズ</h2>
<section class="list" id="phraseList"></section>

<div class="small muted" style="margin-top:10px">
  タイ語は正確な拼音（例：<code>sà-wàt-dii</code>）を併記。お気に入り/A–B/速度/シーケンス設定は端末に保存。
</div>

<audio id="player" preload="none" crossOrigin="anonymous"></audio>

<script>
/* ===== 設定 ===== */
let BASE_URL = "./audio/";
try { const u=new URL(location.href); const b=u.searchParams.get('base'); if(b) BASE_URL=b; } catch(e){}
const TTS_LANG_TH = "th-TH";
const TTS_LANG_JP = "ja-JP";

/* ==== 追加：TTSボイス選択 ==== */
let VOICES = [];
function loadVoices(){ VOICES = speechSynthesis.getVoices(); }
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function pickVoice(langTag){
  const key = (langTag || "").toLowerCase();
  // 完全一致 → 言語一致(th 等) の順に探す
  let v = VOICES.find(v => (v.lang || "").toLowerCase() === key);
  if (!v) v = VOICES.find(v => (v.lang || "").toLowerCase().startsWith(key.split("-")[0]));
  return v || null;
}

/* ===== 単語データ =====
  file_th / file_jp は任意。無ければTTSにフォールバック。
*/
const ITEMS = [
  { id:"th-001", th:"สวัสดี", rom:"sà-wàt-dii", jp:"こんにちは", file_th:"th-001-sawatdee.mp3" },
  { id:"th-002", th:"ขอบคุณ", rom:"khɔ̀ɔp-khun", jp:"ありがとう" },
  { id:"th-003", th:"ขอโทษ", rom:"khǎaw-thôot", jp:"ごめんなさい" },
  { id:"th-004", th:"ใช่",   rom:"châi",         jp:"はい（そうです）" },
    // コア動詞
  { id:"core-001", th:"ไป",     rom:"pai",           jp:"行く" },
  { id:"core-002", th:"มา",     rom:"maa",           jp:"来る" },
  { id:"core-003", th:"เป็น",   rom:"pen",           jp:"〜だ（本質）" },
  { id:"core-004", th:"อยู่",   rom:"yùu",           jp:"いる・住む" },
  { id:"core-005", th:"มี",     rom:"mii",           jp:"持つ・ある" },
  { id:"core-006", th:"ทำ",     rom:"tham",          jp:"する・作る" },
  { id:"core-007", th:"กิน",    rom:"kin",           jp:"食べる" },
  { id:"core-008", th:"ดื่ม",   rom:"dʉ̀ʉm",         jp:"飲む" },
  { id:"core-009", th:"ชอบ",    rom:"chɔ̂ɔp",        jp:"好き" },
  { id:"core-010", th:"รู้",     rom:"rúu",           jp:"知る" },
  { id:"core-011", th:"เข้าใจ", rom:"khâo-cai",      jp:"理解する" },
  { id:"core-012", th:"พูด",    rom:"phûut",         jp:"話す" },
  { id:"core-013", th:"เรียน",  rom:"rian",          jp:"学ぶ" },
  { id:"core-014", th:"ดู",     rom:"duu",           jp:"見る" },
  { id:"core-015", th:"ให้",    rom:"hâi",           jp:"与える・〜させる" },

  // 機能語・接続
  { id:"core-020", th:"ไม่",      rom:"mâi",       jp:"〜ない（否定）" },
  { id:"core-021", th:"หรือ",     rom:"rʉ̌ʉ",      jp:"それとも／〜ですか？" },
  { id:"core-022", th:"ที่",       rom:"thîi",      jp:"〜で／〜の／関係詞" },
  { id:"core-023", th:"กับ",      rom:"kàp",       jp:"〜と／一緒に" },
  { id:"core-024", th:"เพราะว่า", rom:"phrɔ́-wâa", jp:"〜だから" },
  { id:"core-025", th:"แต่",      rom:"tɛ̀ɛ",      jp:"しかし" },
  { id:"core-026", th:"แล้ว",     rom:"lɛ́ɛo",     jp:"もう・それから" },
  { id:"core-027", th:"ก็",       rom:"kɔ̂ɔ",      jp:"〜も／そして" },
  { id:"core-028", th:"เลย",      rom:"loei",      jp:"まったく／強調" },

  // 疑問語
  { id:"core-030", th:"ใคร",      rom:"khrai",       jp:"だれ" },
  { id:"core-031", th:"อะไร",     rom:"a-rai",       jp:"何" },
  { id:"core-032", th:"ที่ไหน",    rom:"thîi-nǎi",    jp:"どこ" },
  { id:"core-033", th:"เมื่อไหร่", rom:"mʉ̂a-rài",    jp:"いつ" },
  { id:"core-034", th:"เท่าไหร่",  rom:"thâo-rài",    jp:"いくら／どれくらい" },
  { id:"core-035", th:"ทำไม",     rom:"tham-mai",    jp:"なぜ" },
  { id:"core-036", th:"อย่างไร",  rom:"yàang-rai",   jp:"どのように" },
  { id:"core-037", th:"ยังไง",     rom:"yang-ngai",   jp:"どうやって（口語）" },

  // 形容詞
  { id:"core-040", th:"ดี",     rom:"dii",       jp:"良い" },
  { id:"core-041", th:"ใหม่",   rom:"mài",       jp:"新しい" },
  { id:"core-042", th:"เก่า",   rom:"kào",       jp:"古い" },
  { id:"core-043", th:"สวย",   rom:"sǔai",      jp:"きれい" },
  { id:"core-044", th:"อร่อย", rom:"a-rɔ̀i",     jp:"おいしい" },
  { id:"core-045", th:"ง่าย",  rom:"ngâai",     jp:"簡単" },
  { id:"core-046", th:"ยาก",   rom:"yâak",      jp:"難しい" },
  { id:"core-047", th:"แพง",   rom:"phɛɛng",    jp:"高い（値段）" },
  { id:"core-048", th:"เร็ว",   rom:"reo",       jp:"速い" },
  { id:"core-049", th:"ช้า",    rom:"cháa",      jp:"遅い" },

  // サバイバル表現
  { id:"core-050", th:"ใช่",         rom:"châi",          jp:"はい／そうです" },
  { id:"core-051", th:"ไม่ใช่",      rom:"mâi-châi",      jp:"いいえ／違います" },
  { id:"core-052", th:"ขอบคุณ",     rom:"khɔ̀ɔp-khun",   jp:"ありがとう" },
  { id:"core-053", th:"ขอโทษ",      rom:"khǎaw-thôot",   jp:"ごめんなさい" },
  { id:"core-054", th:"ช่วยหน่อย",  rom:"chûai nɔ̀i",     jp:"〜してください（お願い）" },
    // 追加：よく使う副詞
  { id:"core-060", th:"มาก",     rom:"mâak",     jp:"とても／多い" },
  { id:"core-061", th:"น้อย",    rom:"nɔ́ɔi",    jp:"少し／少ない" },
  { id:"core-062", th:"เสมอ",   rom:"samǒe",    jp:"いつも" },
  { id:"core-063", th:"บ่อย",    rom:"bɔ̀i",     jp:"よく／頻繁に" },
  { id:"core-064", th:"เร็วๆนี้", rom:"reo-reo-níi", jp:"近々／まもなく" },

  // 追加：時間表現
  { id:"core-070", th:"วันนี้",      rom:"wan-níi",    jp:"今日" },
  { id:"core-071", th:"พรุ่งนี้",    rom:"phrûng-níi", jp:"明日" },
  { id:"core-072", th:"เมื่อวาน",    rom:"mʉ̂a-waan",  jp:"昨日" },
  { id:"core-073", th:"ตอนนี้",     rom:"tɔɔn-níi",   jp:"今" },
  { id:"core-074", th:"เดี๋ยวนี้",   rom:"dǐao-níi",   jp:"すぐに" },

  // 追加：場所
  { id:"core-080", th:"บ้าน",     rom:"bâan",      jp:"家" },
  { id:"core-081", th:"โรงเรียน", rom:"rooŋ-rian", jp:"学校" },
  { id:"core-082", th:"ร้านอาหาร", rom:"ráan-aa-hǎan", jp:"レストラン" },
  { id:"core-083", th:"ตลาด",     rom:"tà-làat",   jp:"市場" },
  { id:"core-084", th:"โรงพยาบาล", rom:"rooŋ-pha-yaa-baan", jp:"病院" },
    // 追加：色
  { id:"core-090", th:"สีแดง",   rom:"sǐi dɛɛŋ",   jp:"赤" },
  { id:"core-091", th:"สีฟ้า",   rom:"sǐi fáa",    jp:"水色／空色" },
  { id:"core-092", th:"สีน้ำเงิน", rom:"sǐi náam ŋɤn", jp:"青" },
  { id:"core-093", th:"สีเขียว", rom:"sǐi khǐao",  jp:"緑" },
  { id:"core-094", th:"สีเหลือง", rom:"sǐi lʉ̌aŋ",  jp:"黄" },
  { id:"core-095", th:"สีขาว",   rom:"sǐi khǎao",  jp:"白" },
  { id:"core-096", th:"สีดำ",    rom:"sǐi dam",    jp:"黒" },

  // 追加：数字（1〜10）
  { id:"core-100", th:"หนึ่ง",   rom:"nʉ̀ŋ",   jp:"1" },
  { id:"core-101", th:"สอง",    rom:"sɔ̌ɔŋ",  jp:"2" },
  { id:"core-102", th:"สาม",    rom:"sǎam",   jp:"3" },
  { id:"core-103", th:"สี่",    rom:"sìi",    jp:"4" },
  { id:"core-104", th:"ห้า",    rom:"hâa",    jp:"5" },
  { id:"core-105", th:"หก",     rom:"hòk",    jp:"6" },
  { id:"core-106", th:"เจ็ด",   rom:"cèt",    jp:"7" },
  { id:"core-107", th:"แปด",    rom:"pɛ̀ɛt",  jp:"8" },
  { id:"core-108", th:"เก้า",   rom:"kâao",   jp:"9" },
  { id:"core-109", th:"สิบ",    rom:"sìp",    jp:"10" },

  // 追加：家族
  { id:"core-120", th:"พ่อ",     rom:"phɔ̂ɔ",   jp:"父" },
  { id:"core-121", th:"แม่",     rom:"mɛ̂ɛ",    jp:"母" },
  { id:"core-122", th:"ลูก",     rom:"lûuk",    jp:"子供" },
  { id:"core-123", th:"พี่ชาย",  rom:"phîi-chaai", jp:"兄" },
  { id:"core-124", th:"น้องชาย", rom:"nɔ́ɔŋ-chaai", jp:"弟" },
  { id:"core-125", th:"พี่สาว",  rom:"phîi-sǎao",   jp:"姉" },
  { id:"core-126", th:"น้องสาว", rom:"nɔ́ɔŋ-sǎao",  jp:"妹" },
];
/* ===== フレーズデータ =====
   クリックで語単位検索、再生はTTS（ファイル未指定）。
*/
const PHRASES = [
  { id:"ph-001", th:"สวัสดีครับ ยินดีที่ได้รู้จัก", rom:"sà-wàt-dii khráp, yin-dii thîi dâi rúu-càk", jp:"こんにちは。はじめまして。" },
  { id:"ph-002", th:"คุณสบายดีไหม", rom:"khun sabaaidii mái", jp:"お元気ですか？" },
  { id:"ph-003", th:"ผมหิวข้าวมาก", rom:"phǒm hǐu khâao mâak", jp:"とてもお腹が空きました。" },
  { id:"ph-004", th:"ไปด้วยกันไหม", rom:"pai dûai-kan mái", jp:"一緒に行きませんか？" },
  { id:"ph-005", th:"อันนี้ราคาเท่าไหร่", rom:"an-níi raa-khaa thâo-rài", jp:"これはいくらですか？" },
  { id:"ph-006", th:"ขอบคุณมากครับ", rom:"khɔ̀ɔp-khun mâak khráp", jp:"本当にありがとうございます。" },
  { id:"ph-007", th:"ขอโทษครับ ผมมาสาย", rom:"khǎaw-thôot khráp, phǒm maa săai", jp:"すみません、遅れました。" },
  { id:"ph-008", th:"ช่วยพูดอีกครั้งได้ไหม", rom:"chûai phûut ìik khráng dâi mái", jp:"もう一度言ってもらえますか？" },
  { id:"ph-009", th:"ฉันกำลังเรียนภาษาไทย", rom:"chǎn kam-lang rian phaa-săa thai", jp:"私はタイ語を勉強しています。" },
  { id:"ph-010", th:"นี่อร่อยมากเลย", rom:"nîi a-rɔ̀i mâak loei", jp:"これすごくおいしい！" },
];

/* ===== 参照 ===== */
const list = document.getElementById('list');
const phraseList = document.getElementById('phraseList');   // ← 追加
const q = document.getElementById('q'), clearBtn = document.getElementById('clearBtn');
const player = document.getElementById('player');
const rate = document.getElementById('rate'), rateLabel = document.getElementById('rateLabel');
const minusBtn = document.getElementById('minusBtn'), plusBtn = document.getElementById('plusBtn');
const seqMode = document.getElementById('seqMode'), loopOne = document.getElementById('loopOne');
const seqStart = document.getElementById('seqStart'), seqStop = document.getElementById('seqStop'), np = document.getElementById('np');
const seqPreset = document.getElementById('seqPreset'), seqCustom = document.getElementById('seqCustom'), pauseSec = document.getElementById('pauseSec');
const preferFileTh = document.getElementById('preferFileTh'), preferFileJp = document.getElementById('preferFileJp');

let currentId=null, isContinuous=false, queue=[], queueIndex=-1, speaking=false;

/* ===== 速度 ===== */
function roundRate(x){ const v=Math.round(x*10)/10; return Math.min(2.0, Math.max(0.5, v)); }
function applyRate(v){ const r=roundRate(v); player.playbackRate=r; rate.value=r.toFixed(1); rateLabel.textContent=r.toFixed(1)+'×'; localStorage.setItem('playerRate', r.toFixed(1)); }
(function initRate(){ const saved=parseFloat(localStorage.getItem('playerRate')||'1.0'); applyRate(saved); })();
rate.addEventListener('input', e=>applyRate(parseFloat(e.target.value)));
minusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)-0.1));
plusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)+0.1));

/* ===== お気に入り ===== */
function getFavs(){ try {return JSON.parse(localStorage.getItem('favs')||'[]')} catch(e){return []} }
function setFavs(a){ localStorage.setItem('favs', JSON.stringify(a)); }
function isFav(id){ return getFavs().includes(id); }
function toggleFav(id){ const a=getFavs(); const i=a.indexOf(id); if(i>=0) a.splice(i,1); else a.push(id); setFavs(a); }

/* ===== A-B（語ごと保存。ファイル再生のみ有効） ===== */
function loadABMap(){ try {return JSON.parse(localStorage.getItem('abMap')||'{}')} catch(e){return {}} }
function saveABMap(m){ localStorage.setItem('abMap', JSON.stringify(m)); }
function getAB(id){ const m=loadABMap(); return m[id]||{a:null,b:null,enabled:false}; }
function setAB(id,o){ const m=loadABMap(); m[id]=o; saveABMap(m); }

/* ===== 描画 ===== */
function secondsToMMSS(sec){ if(!isFinite(sec)) return '–:––'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return m+':'+String(s).padStart(2,'0'); }
function render(items){
  list.innerHTML='';
  items.forEach(item=>{
    const card=document.createElement('div'); card.className='card'; card.dataset.id=item.id;

    const head=document.createElement('div'); head.className='head';
    const L=document.createElement('div'); L.className='th';
    const fav=document.createElement('button'); fav.className='fav'; const on=isFav(item.id);
    fav.setAttribute('aria-pressed', on?'true':'false'); fav.textContent=on?'★':'☆';
    fav.addEventListener('click', ()=>{ toggleFav(item.id); const n=isFav(item.id); fav.setAttribute('aria-pressed', n?'true':'false'); fav.textContent=n?'★':'☆'; if(isContinuous && seqMode.value==='favs') buildQueue(); });
    const thText=document.createElement('span'); thText.textContent=item.th;
    L.appendChild(fav); L.appendChild(thText);

    const R=document.createElement('div');
    const playBtn=document.createElement('button'); playBtn.textContent='▶ 再生';
    playBtn.addEventListener('click', ()=>userStart(item));
    R.appendChild(playBtn);

    head.appendChild(L); head.appendChild(R);

    const rom=document.createElement('div'); rom.className='rom'; rom.textContent=item.rom;
    const jp=document.createElement('div'); jp.className='jp'; jp.textContent=item.jp;

    const progWrap=document.createElement('div'); progWrap.className='progress-wrap';
    const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('div'); bar.className='bar'; prog.appendChild(bar);
    const timeLabel=document.createElement('span'); timeLabel.className='small muted'; timeLabel.textContent='0:00';
    progWrap.appendChild(prog); progWrap.appendChild(timeLabel);

    card.appendChild(head); card.appendChild(rom); card.appendChild(jp); card.appendChild(progWrap);
    list.appendChild(card);

    item._els={ playBtn, thText, progWrap, bar, timeLabel };
  });
  updateNowPlayingStyle();
}
// 単語クリックで検索に飛ばすための小ヘルパ
function jumpSearch(word){
  q.value = word;
  doFilter();
  q.focus();
}

// フレーズ描画：タイ語の各語をクリック可能に
function renderPhrases(items){
  phraseList.innerHTML = '';
  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = p.id;

    // 見出し＋再生
    const head = document.createElement('div');
    head.className = 'head';

    const L = document.createElement('div');
    L.className = 'th';

    // タイ語を語単位に分割（空白・句読点でおおまかに）
    const frag = document.createDocumentFragment();
    p.th.split(/(\s+|[,.?!、。！？」」()（）])/).forEach(token=>{
      if(!token) return;
      if(/\s+|[,.?!、。！？」」()（）]/.test(token)){
        frag.appendChild(document.createTextNode(token));
      }else{
        const span = document.createElement('span');
        span.textContent = token;
        span.style.textDecoration = 'underline';
        span.style.textUnderlineOffset = '3px';
        span.style.cursor = 'pointer';
        span.title = 'この語で検索';
        span.addEventListener('click', ()=>jumpSearch(token));
        frag.appendChild(span);
      }
    });
    L.appendChild(frag);

    const R = document.createElement('div');
    const btn = document.createElement('button');
    btn.textContent = '▶ 再生';
    btn.addEventListener('click', ()=> playSequenceFor(p));  // item互換でOK（file未指定→TTS）
    R.appendChild(btn);

    head.appendChild(L); head.appendChild(R);

    const rom = document.createElement('div');
    rom.className='rom';
    rom.textContent = p.rom || '';

    const jp = document.createElement('div');
    jp.className='jp';
    jp.textContent = p.jp || '';

    card.appendChild(head);
    card.appendChild(rom);
    card.appendChild(jp);
    phraseList.appendChild(card);

    // 単語側と同じUI更新用プロパティを最低限用意
    p._els = { playBtn: btn, thText: L };
  });
}

function updateNowPlayingStyle(){
  [...ITEMS, ...PHRASES].forEach(it=>{
    if(!it._els) return;
    it._els.thText.classList.toggle('nowplaying',
      it.id === currentId && (!player.paused || speaking)
    );
  });
}

function updateProgressUI(item){ if(!item||!item._els) return; const {bar,timeLabel}=item._els; const dur=player.duration||0, cur=player.currentTime||0; const pct=dur?Math.min(100, Math.max(0,(cur/dur)*100)):0; bar.style.width=pct+'%'; timeLabel.textContent=secondsToMMSS(cur)+(dur?' / '+secondsToMMSS(dur):''); }
let progressTimer=null;
function startProgress(item){ stopProgress(); progressTimer=setInterval(()=>updateProgressUI(item),200); }
function stopProgress(){ if(progressTimer) clearInterval(progressTimer); progressTimer=null; }

/* ===== シーケンス設定 保存/復元 ===== */
function saveSeqPrefs(){
  const obj={preset:seqPreset.value, custom:seqCustom.value, pause:parseFloat(pauseSec.value)||0.8, pfTh:preferFileTh.checked, pfJp:preferFileJp.checked};
  localStorage.setItem('seqPrefs', JSON.stringify(obj));
}
function loadSeqPrefs(){
  try{
    const o=JSON.parse(localStorage.getItem('seqPrefs')||'{}');
    if(o.preset) seqPreset.value=o.preset;
    if(o.custom) seqCustom.value=o.custom;
    if(o.pause!=null) pauseSec.value=o.pause;
    if(o.pfTh!=null) preferFileTh.checked=o.pfTh;
    if(o.pfJp!=null) preferFileJp.checked=o.pfJp;
  }catch(e){}
}
[seqPreset,seqCustom,pauseSec,preferFileTh,preferFileJp].forEach(el=>el.addEventListener('change', saveSeqPrefs));
loadSeqPrefs();

/* ===== 再生エンジン ===== */
function patternSteps(){
  const v = (seqPreset.value==='custom' ? seqCustom.value : seqPreset.value).trim();
  return v.split(',').map(s=>s.trim()).filter(Boolean); // 'th','jp','pause'
}
function tts(text, lang, rate){
  return new Promise((resolve,reject)=>{
    const u = new SpeechSynthesisUtterance(text);
    const v = pickVoice(lang);     // ← ここで言語に合う声を選ぶ
    if (v) u.voice = v;
    u.lang = v?.lang || lang;      // ヒントとして言語も指定
    u.rate = rate;
    u.onstart = ()=>{ speaking=true; updateNowPlayingStyle(); };
    u.onend   = ()=>{ speaking=false; resolve(); };
    u.onerror = e =>{ speaking=false; reject(e); };
    speechSynthesis.cancel();      // 多重再生防止
    speechSynthesis.speak(u);
  });
}
function playFile(src, ab){ // ab: {enabled,a,b}
  return new Promise((resolve,reject)=>{
    player.src = src;
    const onEnded = ()=>{ cleanup(); resolve(); };
    const onTime = ()=>{
      if(ab && ab.enabled && ab.a!=null && ab.b!=null){
        const eps=0.02; if(player.currentTime >= ab.b-eps){ player.currentTime = ab.a; }
      }
    };
    const onErr = (e)=>{ cleanup(); reject(e); };
    function cleanup(){ player.removeEventListener('ended', onEnded); player.removeEventListener('timeupdate', onTime); player.removeEventListener('error', onErr); stopProgress(); }
    player.play().then(()=>{
      startProgress(ITEMS.find(it=>it.id===currentId));
      player.addEventListener('ended', onEnded);
      player.addEventListener('timeupdate', onTime);
      player.addEventListener('error', onErr);
    }).catch(onErr);
  });
}
function fileUrl(name){ return BASE_URL + name; }

async function playSequenceFor(item){
  currentId = item.id;
  updateNowPlayingStyle();
  setAllButtonsToPlay(); item._els.playBtn.textContent='⏸ 停止';
  np.textContent = 'Now Playing: ' + item.th + ' (' + item.jp + ')';

  const rateVal = parseFloat(localStorage.getItem('playerRate')||'1.0');
  const ab = getAB(item.id); // ファイル再生時のみ使用
  const steps = patternSteps();
  for (let step of steps){
    if(step==='pause'){ await new Promise(r=>setTimeout(r, Math.max(0, (parseFloat(pauseSec.value)||0.8)*1000))); continue; }
    if(step==='th'){
      const useFile = preferFileTh.checked && item.file_th;
      if(useFile){
        // A-B有効（ファイルのみ）
        player.playbackRate = rateVal;
        startProgress(item);
        await playFile(fileUrl(item.file_th), ab.enabled?ab:null).catch(()=>{});
      }else{
        stopProgress();
        await tts(item.th, TTS_LANG_TH, rateVal).catch(()=>{});
      }
    }
    if(step==='jp'){
      const useFile = preferFileJp.checked && item.file_jp;
      if(useFile){
        player.playbackRate = rateVal;
        startProgress(item);
        await playFile(fileUrl(item.file_jp), null).catch(()=>{});
      }else{
        stopProgress();
        await tts(item.jp, TTS_LANG_JP, rateVal).catch(()=>{});
      }
    }
  }
}
function setAllButtonsToPlay(){ ITEMS.forEach(it=>{ if(it._els) it._els.playBtn.textContent='▶ 再生'; }); }

async function userStart(item){
  // 連続再生中の位置調整
  if (isContinuous) {
    const ix = queue.findIndex(x => x.id === item.id);
    if (ix >= 0) queueIndex = ix; else { seqMode.value='all'; buildQueue(); queueIndex = queue.findIndex(x => x.id === item.id); }
  }
  // 実行
  await playSequenceFor(item);
  // 1トークン終了後の遷移
  if (!isContinuous) { currentId=null; setAllButtonsToPlay(); updateNowPlayingStyle(); np.textContent=''; return; }
  if (loopOne.checked) { userStart(item); return; }
  queueIndex++; if(queueIndex>=queue.length){ stopContinuous(); return; }
  userStart(queue[queueIndex]);
}

/* ===== 連続再生 ===== */
function buildQueue(){ if(seqMode.value==='favs'){ const fav=new Set(getFavs()); queue = ITEMS.filter(it=>fav.has(it.id)); } else { queue = ITEMS.slice(); } }
function startContinuous(){ buildQueue(); if(!queue.length){ alert(seqMode.value==='favs'?'お気に入りが空です。☆をつけてください。':'再生対象がありません。'); return; } isContinuous=true; const ix=currentId?queue.findIndex(x=>x.id===currentId):-1; queueIndex=ix>=0?ix:0; userStart(queue[queueIndex]); seqStart.disabled=true; seqMode.disabled=true; }
function stopContinuous(){ isContinuous=false; queue=[]; queueIndex=-1; seqStart.disabled=false; seqMode.disabled=false; np.textContent=''; }
seqStart.addEventListener('click', startContinuous);
seqStop.addEventListener('click', ()=>{ stopContinuous(); speechSynthesis.cancel(); if(!player.paused){ player.pause(); } });

/* ===== 検索 ===== */
function doFilter(){
  const v = q.value.trim().toLowerCase();
  const wordFiltered = ITEMS.filter(it =>
    it.th.toLowerCase().includes(v) ||
    it.rom.toLowerCase().includes(v) ||
    it.jp.toLowerCase().includes(v)
  );
  render(wordFiltered);

  const phraseFiltered = PHRASES.filter(p =>
    (p.th||'').toLowerCase().includes(v) ||
    (p.rom||'').toLowerCase().includes(v) ||
    (p.jp||'').toLowerCase().includes(v)
  );
  renderPhrases(phraseFiltered);
}
q.addEventListener('input', doFilter); clearBtn.addEventListener('click', ()=>{ q.value=''; doFilter(); });

/* ===== 初期描画 ===== */
render(ITEMS);
renderPhrases(PHRASES);
</script>
</body>
</html>
