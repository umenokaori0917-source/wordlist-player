<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>単語リストプレイヤー（A-B対応・TTSフォールバック・順序/ポーズカスタム）</title>
<style>
  :root { --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans Thai", sans-serif; margin: 16px; }
  header { display: grid; gap: 10px; margin-bottom: 16px; }
  h1 { font-size: 1.15rem; margin: 0; }
  .tip { color:#555; font-size:.9rem; line-height:1.4; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  input[type="search"]{ flex:1 1 240px; padding:10px 12px; border:1px solid #ddd; border-radius: 10px; }
  button, .btn { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius: 10px; cursor:pointer; }
  button:hover, .btn:hover { background:#f5f5f5; }
  select, .select, input[type="number"], input[type="text"] { padding:8px 10px; border:1px solid #ddd; border-radius:10px; }
  .pill { font-size:.75rem; color:#666; border:1px solid #e5e5e5; padding:2px 6px; border-radius:999px;}
  .list { display:grid; gap: 12px; }
  .card { border:1px solid #eee; border-radius: 10px; padding: 10px 12px; display:grid; gap:8px; }
  .head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .th { font-size: 1.15rem; font-weight:600; display:flex; align-items:center; gap:8px; }
  .rom { color:#333; font-family: ui-monospace, Menlo, Consolas, monospace; }
  .jp { color:#666; }
  .fav { border:none; background:transparent; font-size: 1.1rem; padding:4px 6px; cursor:pointer; }
  .fav[aria-pressed="true"]{ color:#e39; }
  .progress-wrap{ display:flex; align-items:center; gap:6px; }
  .progress{ height:6px; background:#eee; border-radius:999px; overflow:hidden; width:160px; }
  .bar{ height:100%; width:0%; background:#999; }
  .muted { color:#999; }
  .small { font-size:.82rem; }
  .hidden { display:none; }
  .nowplaying { font-weight:600; }
  .warn { color:#a33; }
  .group { display:grid; gap:8px; padding:10px; border:1px dashed #ddd; border-radius:10px; }
  .kv { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
</style>
</head>
<body>
<header>
  <h1>単語リストプレイヤー（A-B対応・TTSフォールバック・順序/ポーズカスタム）</h1>
  <div class="tip small">
    ファイルがある語は<strong>ファイル再生</strong>（A–B可）、無い語は<strong>TTS</strong>に自動フォールバック。<br>
    BASE_URL 既定: <code>./audio/</code>（?base=… で上書き可）
  </div>

  <!-- 検索・速度・連続再生 -->
  <div class="row">
    <input id="q" type="search" placeholder="検索：タイ語 / ローマ字 / 日本語 で絞り込み">
    <button id="clearBtn">クリア</button>
    <label class="small">
  級フィルタ
  <select id="levelFilter">
    <option value="">（なし）</option>
    <option value="k5">タイ語検定5級</option>
    <option value="k4">タイ語検定4級</option>
    <option value="k3">タイ語検定3級</option>
    <option value="kp2">タイ語検定準2級</option>
    <option value="k2">タイ語検定2級</option>
    <option value="k1">タイ語検定1級</option>
  </select>
</label>


    <span>速度</span>
    <button id="minusBtn">−</button>
    <input id="rate" type="range" min="0.5" max="2.0" step="0.1" value="1.0" style="width:200px">
    <button id="plusBtn">＋</button>
    <span id="rateLabel" class="pill">1.0×</span>

    <span class="pill small">再生対象</span>
    <select id="seqMode">
    <label class="small">
      連続対象
      <select id="contScope">
        <option value="both">単語＋フレーズ</option>
        <option value="items">単語のみ</option>
        <option value="phrases">フレーズのみ</option>
      </select>
    </label>

      <option value="all">一覧（全体）</option>
      <option value="favs">お気に入りのみ</option>
    </select>
    <label class="small"><input id="loopOne" type="checkbox"> 1語ループ</label>
    <button id="seqStart">▶ 連続</button>
    <button id="seqStop">■ 停止</button>
    <label class="small"><input id="resumeToggle" type="checkbox"> 続きから再開</label>
    <button id="clearResume" class="btn">位置クリア</button>
    <span id="np" class="small muted"></span>
  </div>

  <!-- シーケンス設定 -->
  <div class="group">
    <div class="kv">
      <strong>シーケンス（1語あたりの流れ）</strong>
      <select id="seqPreset">
        <option value="th,jp">タイ語→日本語</option>
        <option value="jp,th">日本語→タイ語</option>
        <option value="th,pause,jp">タイ語→ポーズ→日本語</option>
        <option value="custom">カスタム</option>
      </select>
      <label class="small">カスタム: <input id="seqCustom" type="text" value="th,pause,jp" size="20"> <span class="muted small">（例: th,jp / jp,th / th,pause,jp など）</span></label>
      <label class="small">ポーズ秒: <input id="pauseSec" type="number" min="0" step="0.1" value="0.8" style="width:80px"></label>
    </div>
    <div class="kv">
      <span class="pill small">再生ソース</span>
      <label class="small"><input id="preferFileTh" type="checkbox" checked> タイ語はファイル優先（無ければTTS）</label>
      <label class="small"><input id="preferFileJp" type="checkbox"> 日本語もファイル優先（無ければTTS）</label>
      <span class="small muted">※ TTSはA–B不可。A–Bしたい語はファイルを用意してください。</span>
    </div>
  </div>
  <!-- 表示/非表示 切替 -->
<div class="group">
  <div class="kv">
    <strong>表示/非表示</strong>
    <label class="small"><input type="checkbox" id="hideTh"> タイ語を隠す</label>
    <label class="small"><input type="checkbox" id="hideRom"> ピンインを隠す</label>
    <label class="small"><input type="checkbox" id="hideJp"> 日本語を隠す</label>
    <label class="small"><input type="checkbox" id="audioOnly"> 音だけ（全部隠す）</label>
    <button id="showAll" class="btn">全表示</button>
  </div>
  <div class="small muted">※「音だけ」は上の3つを無視して全て隠します（音声は再生されます）。</div>
</div>
</header>

<section class="list" id="list"></section>
<h2 style="margin:14px 0 6px;">フレーズ</h2>
<section class="list" id="phraseList"></section>
<h2 style="margin:14px 0 6px;">今日の学習目標</h2>
<section id="todayGoal" class="list"></section>
<div class="row">
  <span id="todayMeta" class="pill small">Day1 / 目標: 0項目</span>
  <span id="streak" class="pill small">連続日数: 0日</span>
  <button id="resetStart" class="btn">学習開始日を今日に再設定</button>
</div>

<div class="small muted" style="margin-top:10px">
  タイ語は正確な拼音（例：<code>sà-wàt-dii</code>）を併記。お気に入り/A–B/速度/シーケンス設定は端末に保存。
</div>

<audio id="player" preload="none" crossOrigin="anonymous"></audio>

<script>
/* ===== 設定 ===== */
let BASE_URL = "./audio/";
try { const u=new URL(location.href); const b=u.searchParams.get('base'); if(b) BASE_URL=b; } catch(e){}
const TTS_LANG_TH = "th-TH";
const TTS_LANG_JP = "ja-JP";

/* ==== 追加：TTSボイス選択 ==== */
let VOICES = [];
function loadVoices(){ VOICES = speechSynthesis.getVoices(); }
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function pickVoice(langTag){
  const key = (langTag || "").toLowerCase();
  // 完全一致 → 言語一致(th 等) の順に探す
  let v = VOICES.find(v => (v.lang || "").toLowerCase() === key);
  if (!v) v = VOICES.find(v => (v.lang || "").toLowerCase().startsWith(key.split("-")[0]));
  return v || null;
}

/* ===== 単語データ =====
  file_th / file_jp は任意。無ければTTSにフォールバック。
*/
const ITEMS = [
  { id:"th-001", th:"สวัสดี", rom:"sà-wàt-dii", jp:"こんにちは", file_th:"th-001-sawatdee.mp3" },
  { id:"th-002", th:"ขอบคุณ", rom:"khɔ̀ɔp-khun", jp:"ありがとう" },
  { id:"th-003", th:"ขอโทษ", rom:"khǎaw-thôot", jp:"ごめんなさい" },
  { id:"th-004", th:"ใช่",   rom:"châi",         jp:"はい（そうです）" },
    // コア動詞
  { id:"core-001", th:"ไป",     rom:"pai",           jp:"行く" },
  { id:"core-002", th:"มา",     rom:"maa",           jp:"来る" },
  { id:"core-003", th:"เป็น",   rom:"pen",           jp:"〜だ（本質）" },
  { id:"core-004", th:"อยู่",   rom:"yùu",           jp:"いる・住む" },
  { id:"core-005", th:"มี",     rom:"mii",           jp:"持つ・ある" },
  { id:"core-006", th:"ทำ",     rom:"tham",          jp:"する・作る" },
  { id:"core-007", th:"กิน",    rom:"kin",           jp:"食べる" },
  { id:"core-008", th:"ดื่ม",   rom:"dʉ̀ʉm",         jp:"飲む" },
  { id:"core-009", th:"ชอบ",    rom:"chɔ̂ɔp",        jp:"好き" },
  { id:"core-010", th:"รู้",     rom:"rúu",           jp:"知る" },
  { id:"core-011", th:"เข้าใจ", rom:"khâo-cai",      jp:"理解する" },
  { id:"core-012", th:"พูด",    rom:"phûut",         jp:"話す" },
  { id:"core-013", th:"เรียน",  rom:"rian",          jp:"学ぶ" },
  { id:"core-014", th:"ดู",     rom:"duu",           jp:"見る" },
  { id:"core-015", th:"ให้",    rom:"hâi",           jp:"与える・〜させる" },

  // 機能語・接続
  { id:"core-020", th:"ไม่",      rom:"mâi",       jp:"〜ない（否定）" },
  { id:"core-021", th:"หรือ",     rom:"rʉ̌ʉ",      jp:"それとも／〜ですか？" },
  { id:"core-022", th:"ที่",       rom:"thîi",      jp:"〜で／〜の／関係詞" },
  { id:"core-023", th:"กับ",      rom:"kàp",       jp:"〜と／一緒に" },
  { id:"core-024", th:"เพราะว่า", rom:"phrɔ́-wâa", jp:"〜だから" },
  { id:"core-025", th:"แต่",      rom:"tɛ̀ɛ",      jp:"しかし" },
  { id:"core-026", th:"แล้ว",     rom:"lɛ́ɛo",     jp:"もう・それから" },
  { id:"core-027", th:"ก็",       rom:"kɔ̂ɔ",      jp:"〜も／そして" },
  { id:"core-028", th:"เลย",      rom:"loei",      jp:"まったく／強調" },

  // 疑問語
  { id:"core-030", th:"ใคร",      rom:"khrai",       jp:"だれ" },
  { id:"core-031", th:"อะไร",     rom:"a-rai",       jp:"何" },
  { id:"core-032", th:"ที่ไหน",    rom:"thîi-nǎi",    jp:"どこ" },
  { id:"core-033", th:"เมื่อไหร่", rom:"mʉ̂a-rài",    jp:"いつ" },
  { id:"core-034", th:"เท่าไหร่",  rom:"thâo-rài",    jp:"いくら／どれくらい" },
  { id:"core-035", th:"ทำไม",     rom:"tham-mai",    jp:"なぜ" },
  { id:"core-036", th:"อย่างไร",  rom:"yàang-rai",   jp:"どのように" },
  { id:"core-037", th:"ยังไง",     rom:"yang-ngai",   jp:"どうやって（口語）" },

  // 形容詞
  { id:"core-040", th:"ดี",     rom:"dii",       jp:"良い" },
  { id:"core-041", th:"ใหม่",   rom:"mài",       jp:"新しい" },
  { id:"core-042", th:"เก่า",   rom:"kào",       jp:"古い" },
  { id:"core-043", th:"สวย",   rom:"sǔai",      jp:"きれい" },
  { id:"core-044", th:"อร่อย", rom:"a-rɔ̀i",     jp:"おいしい" },
  { id:"core-045", th:"ง่าย",  rom:"ngâai",     jp:"簡単" },
  { id:"core-046", th:"ยาก",   rom:"yâak",      jp:"難しい" },
  { id:"core-047", th:"แพง",   rom:"phɛɛng",    jp:"高い（値段）" },
  { id:"core-048", th:"เร็ว",   rom:"reo",       jp:"速い" },
  { id:"core-049", th:"ช้า",    rom:"cháa",      jp:"遅い" },

  // サバイバル表現
  { id:"core-050", th:"ใช่",         rom:"châi",          jp:"はい／そうです" },
  { id:"core-051", th:"ไม่ใช่",      rom:"mâi-châi",      jp:"いいえ／違います" },
  { id:"core-052", th:"ขอบคุณ",     rom:"khɔ̀ɔp-khun",   jp:"ありがとう" },
  { id:"core-053", th:"ขอโทษ",      rom:"khǎaw-thôot",   jp:"ごめんなさい" },
  { id:"core-054", th:"ช่วยหน่อย",  rom:"chûai nɔ̀i",     jp:"〜してください（お願い）" },
    // 追加：よく使う副詞
  { id:"core-060", th:"มาก",     rom:"mâak",     jp:"とても／多い" },
  { id:"core-061", th:"น้อย",    rom:"nɔ́ɔi",    jp:"少し／少ない" },
  { id:"core-062", th:"เสมอ",   rom:"samǒe",    jp:"いつも" },
  { id:"core-063", th:"บ่อย",    rom:"bɔ̀i",     jp:"よく／頻繁に" },
  { id:"core-064", th:"เร็วๆนี้", rom:"reo-reo-níi", jp:"近々／まもなく" },

  // 追加：時間表現
  { id:"core-070", th:"วันนี้",      rom:"wan-níi",    jp:"今日" },
  { id:"core-071", th:"พรุ่งนี้",    rom:"phrûng-níi", jp:"明日" },
  { id:"core-072", th:"เมื่อวาน",    rom:"mʉ̂a-waan",  jp:"昨日" },
  { id:"core-073", th:"ตอนนี้",     rom:"tɔɔn-níi",   jp:"今" },
  { id:"core-074", th:"เดี๋ยวนี้",   rom:"dǐao-níi",   jp:"すぐに" },

  // 追加：場所
  { id:"core-080", th:"บ้าน",     rom:"bâan",      jp:"家" },
  { id:"core-081", th:"โรงเรียน", rom:"rooŋ-rian", jp:"学校" },
  { id:"core-082", th:"ร้านอาหาร", rom:"ráan-aa-hǎan", jp:"レストラン" },
  { id:"core-083", th:"ตลาด",     rom:"tà-làat",   jp:"市場" },
  { id:"core-084", th:"โรงพยาบาล", rom:"rooŋ-pha-yaa-baan", jp:"病院" },
    // 追加：色
  { id:"core-090", th:"สีแดง",   rom:"sǐi dɛɛŋ",   jp:"赤" },
  { id:"core-091", th:"สีฟ้า",   rom:"sǐi fáa",    jp:"水色／空色" },
  { id:"core-092", th:"สีน้ำเงิน", rom:"sǐi náam ŋɤn", jp:"青" },
  { id:"core-093", th:"สีเขียว", rom:"sǐi khǐao",  jp:"緑" },
  { id:"core-094", th:"สีเหลือง", rom:"sǐi lʉ̌aŋ",  jp:"黄" },
  { id:"core-095", th:"สีขาว",   rom:"sǐi khǎao",  jp:"白" },
  { id:"core-096", th:"สีดำ",    rom:"sǐi dam",    jp:"黒" },

  // 追加：数字（1〜10）
  { id:"core-100", th:"หนึ่ง",   rom:"nʉ̀ŋ",   jp:"1" },
  { id:"core-101", th:"สอง",    rom:"sɔ̌ɔŋ",  jp:"2" },
  { id:"core-102", th:"สาม",    rom:"sǎam",   jp:"3" },
  { id:"core-103", th:"สี่",    rom:"sìi",    jp:"4" },
  { id:"core-104", th:"ห้า",    rom:"hâa",    jp:"5" },
  { id:"core-105", th:"หก",     rom:"hòk",    jp:"6" },
  { id:"core-106", th:"เจ็ด",   rom:"cèt",    jp:"7" },
  { id:"core-107", th:"แปด",    rom:"pɛ̀ɛt",  jp:"8" },
  { id:"core-108", th:"เก้า",   rom:"kâao",   jp:"9" },
  { id:"core-109", th:"สิบ",    rom:"sìp",    jp:"10" },

  // 追加：家族
  { id:"core-120", th:"พ่อ",     rom:"phɔ̂ɔ",   jp:"父" },
  { id:"core-121", th:"แม่",     rom:"mɛ̂ɛ",    jp:"母" },
  { id:"core-122", th:"ลูก",     rom:"lûuk",    jp:"子供" },
  { id:"core-123", th:"พี่ชาย",  rom:"phîi-chaai", jp:"兄" },
  { id:"core-124", th:"น้องชาย", rom:"nɔ́ɔŋ-chaai", jp:"弟" },
  { id:"core-125", th:"พี่สาว",  rom:"phîi-sǎao",   jp:"姉" },
  { id:"core-126", th:"น้องสาว", rom:"nɔ́ɔŋ-sǎao",  jp:"妹" },
    // 追加：動詞（K5〜K4）
  { id:"core-130", th:"นอน",   rom:"nɔɔn",    jp:"寝る", lvl:["k5"] },
  { id:"core-131", th:"ตื่น",   rom:"tʉ̀ʉn",   jp:"起きる", lvl:["k5"] },
  { id:"core-132", th:"ขับรถ", rom:"khàp-rót", jp:"運転する", lvl:["k4"] },
  { id:"core-133", th:"เดิน",   rom:"dəən",    jp:"歩く", lvl:["k5"] },
  { id:"core-134", th:"วิ่ง",   rom:"wîŋ",     jp:"走る", lvl:["k5"] },

  // 追加：名詞（K5〜K4）
  { id:"core-140", th:"หนังสือ", rom:"nǎŋ-sʉ̌ʉ", jp:"本", lvl:["k5"] },
  { id:"core-141", th:"เพื่อน",  rom:"phʉ̂an",   jp:"友達", lvl:["k5"] },
  { id:"core-142", th:"เงิน",    rom:"ŋən",      jp:"お金", lvl:["k5"] },
  { id:"core-143", th:"งาน",    rom:"ŋaan",     jp:"仕事", lvl:["k5"] },
  { id:"core-144", th:"เวลา",   rom:"wee-laa",  jp:"時間", lvl:["k5"] },

  // 追加：天気・自然
  { id:"core-150", th:"หนาว",   rom:"nǎao",     jp:"寒い", lvl:["k5"] },
  { id:"core-151", th:"ลม",     rom:"lom",      jp:"風", lvl:["k5"] },
  { id:"core-152", th:"หิมะ",   rom:"hì-má",    jp:"雪", lvl:["k4"] },
  { id:"core-153", th:"ทะเล",   rom:"tha-lee",  jp:"海", lvl:["k5"] },
  { id:"core-154", th:"ภูเขา",  rom:"phuu-khǎo", jp:"山", lvl:["k5"] },
    // ===== k5 基本単語（追加分） =====
  // 数字（11〜20, 100）
  { id:"core-110", th:"สิบเอ็ด", rom:"sìp-èt", jp:"11", lvl:["k5"] },
  { id:"core-111", th:"สิบสอง", rom:"sìp-sɔ̌ɔŋ", jp:"12", lvl:["k5"] },
  { id:"core-112", th:"สิบสาม", rom:"sìp-sǎam", jp:"13", lvl:["k5"] },
  { id:"core-113", th:"สิบสี่", rom:"sìp-sìi", jp:"14", lvl:["k5"] },
  { id:"core-114", th:"สิบห้า", rom:"sìp-hâa", jp:"15", lvl:["k5"] },
  { id:"core-115", th:"สิบหก", rom:"sìp-hòk", jp:"16", lvl:["k5"] },
  { id:"core-116", th:"สิบเจ็ด", rom:"sìp-cèt", jp:"17", lvl:["k5"] },
  { id:"core-117", th:"สิบแปด", rom:"sìp-pɛ̀ɛt", jp:"18", lvl:["k5"] },
  { id:"core-118", th:"สิบเก้า", rom:"sìp-kâao", jp:"19", lvl:["k5"] },
  { id:"core-119", th:"ยี่สิบ", rom:"yîi-sìp", jp:"20", lvl:["k5"] },
  { id:"core-160", th:"ร้อย", rom:"rɔ́ɔi", jp:"100", lvl:["k5"] },

  // 曜日
  { id:"core-170", th:"วันจันทร์", rom:"wan-can", jp:"月曜日", lvl:["k5"] },
  { id:"core-171", th:"วันอังคาร", rom:"wan-ang-khaan", jp:"火曜日", lvl:["k5"] },
  { id:"core-172", th:"วันพุธ", rom:"wan-phút", jp:"水曜日", lvl:["k5"] },
  { id:"core-173", th:"วันพฤหัสบดี", rom:"wan-phá-rʉ́-hàt", jp:"木曜日", lvl:["k5"] },
  { id:"core-174", th:"วันศุกร์", rom:"wan-sùk", jp:"金曜日", lvl:["k5"] },
  { id:"core-175", th:"วันเสาร์", rom:"wan-sǎo", jp:"土曜日", lvl:["k5"] },
  { id:"core-176", th:"วันอาทิตย์", rom:"wan-aa-thít", jp:"日曜日", lvl:["k5"] },

  // 季節・時間
  { id:"core-180", th:"เช้า", rom:"cháao", jp:"朝", lvl:["k5"] },
  { id:"core-181", th:"บ่าย", rom:"bàai", jp:"昼・午後", lvl:["k5"] },
  { id:"core-182", th:"เย็น", rom:"yen", jp:"夕方", lvl:["k5"] },
  { id:"core-183", th:"กลางคืน", rom:"klaang-kʉʉn", jp:"夜", lvl:["k5"] },

  // 家・身の回り
  { id:"core-190", th:"ห้อง", rom:"hɔ̂ŋ", jp:"部屋", lvl:["k5"] },
  { id:"core-191", th:"เตียง", rom:"tiaŋ", jp:"ベッド", lvl:["k5"] },
  { id:"core-192", th:"เก้าอี้", rom:"kâo-îi", jp:"椅子", lvl:["k5"] },
  { id:"core-193", th:"โต๊ะ", rom:"tó", jp:"机・テーブル", lvl:["k5"] },
  { id:"core-194", th:"ประตู", rom:"prà-tuu", jp:"ドア", lvl:["k5"] },
  { id:"core-195", th:"หน้าต่าง", rom:"nâa-tàaŋ", jp:"窓", lvl:["k5"] },

  // 人称代名詞（追加）
  { id:"core-200", th:"ฉัน", rom:"chǎn", jp:"私（女性）", lvl:["k5"] },
  { id:"core-201", th:"ผม", rom:"phǒm", jp:"私（男性）", lvl:["k5"] },
  { id:"core-202", th:"คุณ", rom:"khun", jp:"あなた", lvl:["k5"] },
  { id:"core-203", th:"เรา", rom:"rao", jp:"私たち", lvl:["k5"] },
  { id:"core-204", th:"เขา", rom:"kháo", jp:"彼／彼女", lvl:["k5"] },
    // ===== k4 追加：動詞・助動・使役/可能・移動/日常動作
  { id:"core-210", th:"ซื้อ",     rom:"sʉ́ʉ",         jp:"買う", lvl:["k4"] },
  { id:"core-211", th:"ขาย",     rom:"khǎai",        jp:"売る", lvl:["k4"] },
  { id:"core-212", th:"เปิด",    rom:"pə̀ət",        jp:"開ける・つける", lvl:["k4"] },
  { id:"core-213", th:"ปิด",     rom:"pìt",          jp:"閉める・消す", lvl:["k4"] },
  { id:"core-214", th:"ใส่",     rom:"sài",          jp:"着る・入れる", lvl:["k4"] },
  { id:"core-215", th:"ถอด",     rom:"thɔ̀ɔt",       jp:"脱ぐ・外す", lvl:["k4"] },
  { id:"core-216", th:"นั่ง",     rom:"nâŋ",          jp:"座る", lvl:["k4"] },
  { id:"core-217", th:"ยืน",     rom:"yʉʉn",         jp:"立つ", lvl:["k4"] },
  { id:"core-218", th:"จ่าย",     rom:"càai",         jp:"支払う", lvl:["k4"] },
  { id:"core-219", th:"คุย",     rom:"khui",         jp:"話す・会話する", lvl:["k4"] },
  { id:"core-220", th:"โทร",     rom:"thoo",         jp:"電話する", lvl:["k4"] },
  { id:"core-221", th:"ส่ง",     rom:"sòŋ",          jp:"送る", lvl:["k4"] },
  { id:"core-222", th:"หยุด",     rom:"yùt",          jp:"止まる・やめる", lvl:["k4"] },
  { id:"core-223", th:"เริ่ม",    rom:"rɤ̂ɤm",        jp:"始める", lvl:["k4"] },
  { id:"core-224", th:"ต่อ",     rom:"tɔ̀ɔ",         jp:"続ける・乗り継ぐ", lvl:["k4"] },
  { id:"core-225", th:"กลับ",     rom:"klàp",         jp:"戻る・帰る", lvl:["k4"] },
  { id:"core-226", th:"พบ",      rom:"phóp",         jp:"会う・見つける", lvl:["k4"] },
  { id:"core-227", th:"นัด",      rom:"nát",          jp:"約束する・アポを取る", lvl:["k4"] },

  // ===== k4 追加：形容詞・副詞・数量詞
  { id:"core-230", th:"สะอาด",   rom:"sa-àat",       jp:"清潔な", lvl:["k4"] },
  { id:"core-231", th:"สกปรก",   rom:"sòk-kà-pròk",  jp:"汚い", lvl:["k4"] },
  { id:"core-232", th:"เงียบ",   rom:"ŋîiap",        jp:"静かな", lvl:["k4"] },
  { id:"core-233", th:"ดัง",     rom:"daŋ",          jp:"うるさい・有名な", lvl:["k4"] },
  { id:"core-234", th:"สะดวก",   rom:"sa-dùak",      jp:"便利な", lvl:["k4"] },
  { id:"core-235", th:"อันตราย", rom:"an-ta-raai",   jp:"危険な", lvl:["k4"] },
  { id:"core-236", th:"พิเศษ",   rom:"phi-sèt",      jp:"特別な", lvl:["k4"] },
  { id:"core-237", th:"ทั่วๆไป", rom:"thûa-thûa-pai",jp:"一般的に", lvl:["k4"] },
  { id:"core-238", th:"ประมาณ",  rom:"pra-maan",      jp:"約〜・およそ", lvl:["k4"] },
  { id:"core-239", th:"บ้าง",    rom:"bâaŋ",         jp:"いくつか・少し", lvl:["k4"] },

  // ===== k4 追加：場所・交通・施設
  { id:"core-240", th:"สถานี",      rom:"sa-thǎa-nii",   jp:"駅・ステーション", lvl:["k4"] },
  { id:"core-241", th:"ป้ายรถเมล์",  rom:"pâai rót-mee",  jp:"バス停", lvl:["k4"] },
  { id:"core-242", th:"แผนที่",      rom:"phɛ̌ɛn-thîi",    jp:"地図", lvl:["k4"] },
  { id:"core-243", th:"โรงแรม",      rom:"rooŋ-rææm",     jp:"ホテル", lvl:["k4"] },
  { id:"core-244", th:"สนามบิน",     rom:"sa-nǎam-bin",    jp:"空港", lvl:["k4"] },
  { id:"core-245", th:"พิพิธภัณฑ์",  rom:"phi-phít-tha-phan", jp:"博物館", lvl:["k4"] },
  { id:"core-246", th:"สถานทูต",     rom:"sa-thǎa-ná-thûut", jp:"大使館", lvl:["k4"] },

  // ===== k4 追加：時間語（頻度・時制の目印など）
  { id:"core-250", th:"เมื่อกี้",     rom:"mʉ̂a-kîi",        jp:"さっき", lvl:["k4"] },
  { id:"core-251", th:"เมื่อก่อน",    rom:"mʉ̂a-kɔ̀ɔn",      jp:"以前・昔", lvl:["k4"] },
  { id:"core-252", th:"เดี๋ยว",       rom:"dǐao",            jp:"ちょっと（すぐ）", lvl:["k4"] },
  { id:"core-253", th:"บ่อยๆ",       rom:"bɔ̀i-bɔ̀i",        jp:"しばしば", lvl:["k4"] },
  { id:"core-254", th:"บางครั้ง",     rom:"baaŋ-khráŋ",      jp:"ときどき", lvl:["k4"] },

  // ===== k4 追加：前置/後置的な機能語・接続
  { id:"core-260", th:"เพราะ",      rom:"phrɔ́",           jp:"〜なので（理由）", lvl:["k4"] },
  { id:"core-261", th:"ถ้า",        rom:"thâa",            jp:"もし〜なら", lvl:["k4"] },
  { id:"core-262", th:"ก่อน",       rom:"kɔ̀ɔn",           jp:"〜の前に", lvl:["k4"] },
  { id:"core-263", th:"หลัง",       rom:"lǎŋ",             jp:"〜の後で", lvl:["k4"] },
  { id:"core-264", th:"สำหรับ",     rom:"sǎm-ràp",         jp:"〜のために", lvl:["k4"] },
  { id:"core-265", th:"ประมาณว่า",  rom:"pra-maan wâa",    jp:"およそ〜だと", lvl:["k4"] },

  // ===== k4 追加：名詞（生活）
  { id:"core-270", th:"อาหารเช้า",   rom:"aa-hǎan cháao",  jp:"朝ごはん", lvl:["k4"] },
  { id:"core-271", th:"อาหารกลางวัน", rom:"aa-hǎan klaaŋ-wan", jp:"昼ごはん", lvl:["k4"] },
  { id:"core-272", th:"อาหารเย็น",   rom:"aa-hǎan yen",    jp:"夕食", lvl:["k4"] },
  { id:"core-273", th:"ร้านกาแฟ",    rom:"ráan gaa-fææ",   jp:"カフェ", lvl:["k4"] },
  { id:"core-274", th:"เครื่องดื่ม",  rom:"khrʉ̂aŋ dʉ̀ʉm",   jp:"飲み物", lvl:["k4"] },
  { id:"core-275", th:"ของหวาน",     rom:"khɔ̌ɔŋ wǎan",    jp:"デザート", lvl:["k4"] },
];
/* ===== フレーズデータ =====
   クリックで語単位検索、再生はTTS（ファイル未指定）。
*/
const PHRASES = [
  { id:"ph-001", th:"สวัสดีครับ ยินดีที่ได้รู้จัก", rom:"sà-wàt-dii khráp, yin-dii thîi dâi rúu-càk", jp:"こんにちは。はじめまして。" },
  { id:"ph-002", th:"คุณสบายดีไหม", rom:"khun sabaaidii mái", jp:"お元気ですか？" },
  { id:"ph-003", th:"ผมหิวข้าวมาก", rom:"phǒm hǐu khâao mâak", jp:"とてもお腹が空きました。" },
  { id:"ph-004", th:"ไปด้วยกันไหม", rom:"pai dûai-kan mái", jp:"一緒に行きませんか？" },
  { id:"ph-005", th:"อันนี้ราคาเท่าไหร่", rom:"an-níi raa-khaa thâo-rài", jp:"これはいくらですか？" },
  { id:"ph-006", th:"ขอบคุณมากครับ", rom:"khɔ̀ɔp-khun mâak khráp", jp:"本当にありがとうございます。" },
  { id:"ph-007", th:"ขอโทษครับ ผมมาสาย", rom:"khǎaw-thôot khráp, phǒm maa săai", jp:"すみません、遅れました。" },
  { id:"ph-008", th:"ช่วยพูดอีกครั้งได้ไหม", rom:"chûai phûut ìik khráng dâi mái", jp:"もう一度言ってもらえますか？" },
  { id:"ph-009", th:"ฉันกำลังเรียนภาษาไทย", rom:"chǎn kam-lang rian phaa-săa thai", jp:"私はタイ語を勉強しています。" },
  { id:"ph-010", th:"นี่อร่อยมากเลย", rom:"nîi a-rɔ̀i mâak loei", jp:"これすごくおいしい！" },
  { id:"ph-011", th:"ห้องน้ำอยู่ที่ไหน", rom:"hɔ̂ŋ-nám yùu thîi-nǎi", jp:"トイレはどこですか？" },
  { id:"ph-012", th:"ช่วยด้วยครับ", rom:"chûai dûai khráp", jp:"助けてください！" },
  { id:"ph-013", th:"ฉันไม่เข้าใจ", rom:"chǎn mâi khâo-cai", jp:"私は理解できません。" },
  { id:"ph-014", th:"คุณพูดภาษาอังกฤษได้ไหม", rom:"khun phûut phaa-săa ang-grìt dâi mái", jp:"英語を話せますか？" },
  { id:"ph-015", th:"ไปสนามบินอย่างไร", rom:"pai sà-nǎam-bin yàang-rai", jp:"空港へはどう行きますか？" },
  { id:"ph-016", th:"ฉันอยากไปตลาด", rom:"chǎn yàak pai tà-làat", jp:"市場に行きたいです。" },
  { id:"ph-017", th:"รถไฟฟ้าไปที่ไหน", rom:"rót-fai-fáa pai thîi-nǎi", jp:"電車はどこへ行きますか？" },
  { id:"ph-018", th:"ตอนนี้กี่โมง", rom:"tɔɔn-níi kìi mooŋ", jp:"今何時ですか？" },
  { id:"ph-019", th:"อากาศร้อนมาก", rom:"aa-kàat rɔ́ɔn mâak", jp:"とても暑いです。" },
  { id:"ph-020", th:"ฝนตกหนัก", rom:"fǒn tòk nàk", jp:"大雨が降っています。" },
  { id:"ph-021", th:"ฉันอยากกินอาหารไทย", rom:"chǎn yàak kin aa-hǎan thai", jp:"タイ料理を食べたいです。" },
  { id:"ph-022", th:"น้ำเปล่าหนึ่งแก้วครับ", rom:"náam-plàao nʉ̀ŋ gɛ̂ɛo khráp", jp:"水を一杯ください。" },
  { id:"ph-023", th:"เช็คบิลด้วยครับ", rom:"chék bin dûai khráp", jp:"お会計をお願いします。" },
  { id:"ph-024", th:"ลดราคาได้ไหม", rom:"lót raa-khaa dâi mái", jp:"値引きできますか？" },
  { id:"ph-025", th:"ฉันหลงทางครับ", rom:"chǎn lǒŋ thaang khráp", jp:"道に迷いました。" },
  { id:"ph-026", th:"ช่วยถ่ายรูปให้หน่อย", rom:"chûai thàai rûup hâi nɔ̀i", jp:"写真を撮ってもらえますか？" },
  { id:"ph-027", th:"ใกล้สถานีรถไฟไหม", rom:"klâi sà-thǎa-nii rót-fai mái", jp:"駅は近いですか？" },
  { id:"ph-028", th:"ตั๋วไปเชียงใหม่หนึ่งใบ", rom:"tŭa pai chiang-mài nʉ̀ŋ bai", jp:"チェンマイ行きの切符を1枚ください。" },
  { id:"ph-029", th:"มีห้องว่างไหม", rom:"mii hɔ̂ŋ wâang mái", jp:"空いている部屋はありますか？" },
  { id:"ph-030", th:"ช่วยเขียนที่อยู่ให้หน่อย", rom:"chûai khǐan thîi-yùu hâi nɔ̀i", jp:"住所を書いていただけますか？" },
  { id:"ph-031", th:"คุณชื่ออะไร", rom:"khun chʉ̂ʉ a-rai", jp:"お名前は何ですか？", lvl:["k5"] },
  { id:"ph-032", th:"ฉันมาจากญี่ปุ่น", rom:"chǎn maa càak yîi-pùn", jp:"私は日本から来ました。", lvl:["k5"] },
  { id:"ph-033", th:"คุณทำงานที่ไหน", rom:"khun tham-ŋaan thîi-nǎi", jp:"あなたはどこで働いていますか？", lvl:["k4"] },
  { id:"ph-034", th:"วันนี้อากาศดีมาก", rom:"wan-níi aa-kàat dii mâak", jp:"今日はとてもいい天気です。", lvl:["k5"] },
  { id:"ph-035", th:"ฉันอยากไปทะเล", rom:"chǎn yàak pai tha-lee", jp:"海に行きたいです。", lvl:["k5"] },
  { id:"ph-036", th:"คุณอ่านหนังสือเล่มนี้ไหม", rom:"khun àan nǎŋ-sʉ̌ʉ lêm níi mái", jp:"この本を読みますか？", lvl:["k4"] },
  { id:"ph-037", th:"พรุ่งนี้คุณว่างไหม", rom:"phrûng-níi khun wâang mái", jp:"明日暇ですか？", lvl:["k5"] },
  { id:"ph-038", th:"ฉันไม่มีเงิน", rom:"chǎn mâi mii ŋən", jp:"私はお金がありません。", lvl:["k5"] },
  { id:"ph-039", th:"คุณไปเที่ยวเชียงใหม่บ่อยไหม", rom:"khun pai thîao chiang-mài bɔ̀i mái", jp:"あなたはよくチェンマイに旅行に行きますか？", lvl:["k4"] },
  { id:"ph-040", th:"ช่วยบอกเวลาให้หน่อย", rom:"chûai bòok wee-laa hâi nɔ̀i", jp:"時間を教えてください。", lvl:["k5"] },
  { id:"ph-041", th:"วันนี้วันอะไร", rom:"wan-níi wan a-rai", jp:"今日は何曜日ですか？", lvl:["k5"] },
  { id:"ph-042", th:"พรุ่งนี้วันศุกร์", rom:"phrûng-níi wan sùk", jp:"明日は金曜日です。", lvl:["k5"] },
  { id:"ph-043", th:"ตอนเช้าฉันไปโรงเรียน", rom:"tɔɔn-cháao chǎn pai rooŋ-rian", jp:"朝私は学校に行きます。", lvl:["k5"] },
  { id:"ph-044", th:"ตอนเย็นคุณกินข้าวที่บ้านไหม", rom:"tɔɔn-yen khun kin khâao thîi bâan mái", jp:"夕方は家でご飯を食べますか？", lvl:["k5"] },
  { id:"ph-045", th:"นี่คือเก้าอี้ของฉัน", rom:"nîi khʉʉ kâo-îi khɔ̌ɔŋ chǎn", jp:"これは私の椅子です。", lvl:["k5"] },
  { id:"ph-046", th:"ห้องนอนอยู่ข้างบน", rom:"hɔ̂ŋ-nɔɔn yùu khâang bon", jp:"寝室は上にあります。", lvl:["k5"] },
  { id:"ph-047", th:"ผมไม่มีเวลา", rom:"phǒm mâi mii wee-laa", jp:"私は時間がありません。", lvl:["k5"] },
  { id:"ph-048", th:"เราไปตลาดตอนบ่าย", rom:"rao pai tà-làat tɔɔn-bàai", jp:"私たちは午後市場に行きます。", lvl:["k5"] },
  { id:"ph-049", th:"เขาชอบอ่านหนังสือ", rom:"kháo chɔ̂ɔp àan nǎŋ-sʉ̌ʉ", jp:"彼は本を読むのが好きです。", lvl:["k5"] },
  { id:"ph-050", th:"ฉันมีเพื่อนที่โรงเรียน", rom:"chǎn mii phʉ̂an thîi rooŋ-rian", jp:"私は学校に友達がいます。", lvl:["k5"] },
    // ===== k4 追加フレーズ（移動・買い物・依頼・説明）
  { id:"ph-051", th:"ไปสถานีนี้ยังไงครับ", rom:"pai sa-thǎa-nii níi yaŋŋai khráp", jp:"この駅へはどう行きますか？", lvl:["k4"] },
  { id:"ph-052", th:"ช่วยบอกทางให้หน่อยได้ไหม", rom:"chûai bòok thaang hâi nɔ̀i dâi mái", jp:"道順を教えてもらえますか？", lvl:["k4"] },
  { id:"ph-053", th:"จ่ายด้วยบัตรได้ไหม", rom:"càai dûai bàt dâi mái", jp:"カードで払えますか？", lvl:["k4"] },
  { id:"ph-054", th:"ขอใบเสร็จด้วยครับ", rom:"khɔ̌ɔ bai sèt dûai khráp", jp:"領収書をください。", lvl:["k4"] },
  { id:"ph-055", th:"ร้านนี้เปิดกี่โมง", rom:"ráan níi pə̀ət kìi mooŋ", jp:"この店は何時に開きますか？", lvl:["k4"] },
  { id:"ph-056", th:"ตอนนี้รถเมล์มีไหม", rom:"tɔɔn-níi rót-mee mii mái", jp:"今バスはありますか？", lvl:["k4"] },
  { id:"ph-057", th:"ช่วยนัดเวลาให้หน่อย", rom:"chûai nát wee-laa hâi nɔ̀i", jp:"時間の予約（アポ）をお願いします。", lvl:["k4"] },
  { id:"ph-058", th:"ถ้าฝนตกเราจะปิดหน้าต่าง", rom:"thâa fǒn tòk rao cà pìt nâa-tàaŋ", jp:"もし雨が降ったら窓を閉めます。", lvl:["k4"] },
  { id:"ph-059", th:"ก่อนกลับช่วยโทรหาฉัน", rom:"kɔ̀ɔn klàp chûai thoo hǎa chǎn", jp:"帰る前に私に電話してください。", lvl:["k4"] },
  { id:"ph-060", th:"ประมาณกี่นาทีถึงโรงแรม", rom:"pra-maan kìi naa-thii thʉ̌ŋ rooŋ-rææm", jp:"ホテルまで何分くらいですか？", lvl:["k4"] },

  // ===== k4 追加フレーズ（日常・感想・状態）
  { id:"ph-061", th:"วันนี้ร้านกาแฟคนเยอะมาก", rom:"wan-níi ráan gaa-fææ khon yə́ʉa mâak", jp:"今日はカフェがとても混んでいます。", lvl:["k4"] },
  { id:"ph-062", th:"อาหารเย็นที่นี่อร่อยและไม่แพง", rom:"aa-hǎan yen thîi-nîi a-rɔ̀i lǽ mâi phɛɛŋ", jp:"ここの夕食はおいしくて高くありません。", lvl:["k4"] },
  { id:"ph-063", th:"เงียบกว่านี้หน่อยได้ไหม", rom:"ŋîiap kwàa níi nɔ̀i dâi mái", jp:"もう少し静かにしてもらえますか？", lvl:["k4"] },
  { id:"ph-064", th:"เมื่อกี้ฉันลืมจ่ายเงิน", rom:"mʉ̂a-kîi chǎn lʉʉm càai ŋən", jp:"さっき支払いを忘れました。", lvl:["k4"] },
  { id:"ph-065", th:"สำหรับผมที่นี่สะดวกมาก", rom:"sǎm-ràp phǒm thîi-nîi sa-dùak mâak", jp:"私にとってここはとても便利です。", lvl:["k4"] },
];

/* ===== レベル付与マップ（id -> [levels]） ===== */
const LEVELS = {
  // あいさつ・基本
  "th-001": ["k5"], "th-002": ["k5"], "th-003": ["k5"], "th-004": ["k5"],

  // コア動詞
  "core-001": ["k5"], // ไป
  "core-002": ["k5"], // มา
  "core-003": ["k4"], // เป็น
  "core-004": ["k4"], // อยู่
  "core-005": ["k5"], // มี
  "core-006": ["k4"], // ทำ
  "core-007": ["k5"], // กิน
  "core-008": ["k5"], // ดื่ม
  "core-009": ["k5"], // ชอบ
  "core-010": ["k4"], // รู้
  "core-011": ["k4"], // เข้าใจ
  "core-012": ["k4"], // พูด
  "core-013": ["k5"], // เรียน
  "core-014": ["k5"], // ดู
  "core-015": ["k4"], // ให้

  // 機能語・接続
  "core-020": ["k5"],        // ไม่
  "core-021": ["k5"],        // หรือ
  "core-022": ["k4","k3"],   // ที่（用法広いので複数級にまたがる）
  "core-023": ["k4"],        // กับ
  "core-024": ["k3"],        // เพราะว่า
  "core-025": ["k4"],        // แต่
  "core-026": ["k4"],        // แล้ว
  "core-027": ["k3"],        // ก็
  "core-028": ["k3"],        // เลย

  // 疑問語
  "core-030": ["k5"], "core-031": ["k5"], "core-032": ["k5"],
  "core-033": ["k5"], "core-034": ["k5"], "core-035": ["k5"],
  "core-036": ["k3"], // อย่างไร（ややフォーマル）
  "core-037": ["k4"], // ยังไง（口語）

  // 形容詞
  "core-040": ["k5"], "core-041": ["k5"], "core-042": ["k5"],
  "core-043": ["k5"], "core-044": ["k5"],
  "core-045": ["k4"], "core-046": ["k4"],
  "core-047": ["k5"],
  "core-048": ["k4"], "core-049": ["k4"],

  // サバイバル表現
  "core-050": ["k5"], "core-051": ["k5"], "core-052": ["k5"],
  "core-053": ["k5"], "core-054": ["k5"],

  // 副詞
  "core-060": ["k5"], "core-061": ["k5"],
  "core-062": ["k4"], "core-063": ["k4"],
  "core-064": ["k3"],

  // 時間
  "core-070": ["k5"], "core-071": ["k5"], "core-072": ["k5"],
  "core-073": ["k5"], "core-074": ["k4"],

  // 場所
  "core-080": ["k5"], "core-081": ["k5"], "core-082": ["k5"],
  "core-083": ["k5"], "core-084": ["k5"],

  // 色
  "core-090": ["k5"], "core-091": ["k5"], "core-092": ["k5"],
  "core-093": ["k5"], "core-094": ["k5"], "core-095": ["k5"], "core-096": ["k5"],

  // 数字
  "core-100": ["k5"], "core-101": ["k5"], "core-102": ["k5"], "core-103": ["k5"],
  "core-104": ["k5"], "core-105": ["k5"], "core-106": ["k5"], "core-107": ["k5"],
  "core-108": ["k5"], "core-109": ["k5"],

  // 家族
  "core-120": ["k5"], "core-121": ["k5"], "core-122": ["k5"],
  "core-123": ["k5"], "core-124": ["k5"], "core-125": ["k5"], "core-126": ["k5"],

  /* ===== フレーズ（ph-001〜ph-030） ===== */
  "ph-001": ["k5"], // こんにちは、はじめまして
  "ph-002": ["k5"], // お元気ですか？
  "ph-003": ["k5"], // とてもお腹が空きました
  "ph-004": ["k5"], // 一緒に行きませんか？
  "ph-005": ["k5"], // いくらですか？
  "ph-006": ["k5"], // ありがとうございます
  "ph-007": ["k4"], // すみません、遅れました
  "ph-008": ["k4"], // もう一度言って
  "ph-009": ["k4"], // タイ語を勉強しています
  "ph-010": ["k5"], // おいしい
  "ph-011": ["k4","k5"], // トイレはどこ？
  "ph-012": ["k4"], // 助けて
  "ph-013": ["k5"], // 理解できません
  "ph-014": ["k4"], // 英語話せますか？
  "ph-015": ["k4"], // 空港へどう行く？
  "ph-016": ["k5"], // 市場に行きたい
  "ph-017": ["k4"], // 電車はどこへ？
  "ph-018": ["k5"], // 今何時？
  "ph-019": ["k5"], // 暑い
  "ph-020": ["k4"], // 大雨
  "ph-021": ["k5"], // タイ料理を食べたい
  "ph-022": ["k5"], // 水をください
  "ph-023": ["k4"], // お会計お願いします
  "ph-024": ["k4"], // 値引きできますか
  "ph-025": ["k4"], // 道に迷いました
  "ph-026": ["k4"], // 写真撮ってください
  "ph-027": ["k4"], // 駅は近いですか
  "ph-028": ["k4"], // チェンマイ行きの切符
  "ph-029": ["k4"], // 空いてる部屋はありますか
  "ph-030": ["k4"]  // 住所を書いてください
};

/* ===== 付与：既存データに LEVELS をマージ（多級対応） ===== */
function applyLevels(arr){
  arr.forEach(it=>{
    const extra = LEVELS[it.id] || [];
    if (!it.lvl) it.lvl = [];
    it.lvl = Array.from(new Set([...it.lvl, ...extra])); // 重複排除
  });
}
applyLevels(ITEMS);
applyLevels(PHRASES);

/* ===== 参照 ===== */
const list = document.getElementById('list');
const phraseList = document.getElementById('phraseList');   // ← 追加
const q = document.getElementById('q'), clearBtn = document.getElementById('clearBtn');
const levelFilter = document.getElementById('levelFilter');  // ← 追加
const player = document.getElementById('player');
const rate = document.getElementById('rate'), rateLabel = document.getElementById('rateLabel');
const minusBtn = document.getElementById('minusBtn'), plusBtn = document.getElementById('plusBtn');
const seqMode = document.getElementById('seqMode'), loopOne = document.getElementById('loopOne');
const seqStart = document.getElementById('seqStart'), seqStop = document.getElementById('seqStop'), np = document.getElementById('np');
const seqPreset = document.getElementById('seqPreset'), seqCustom = document.getElementById('seqCustom'), pauseSec = document.getElementById('pauseSec');
const preferFileTh = document.getElementById('preferFileTh'), preferFileJp = document.getElementById('preferFileJp');
const hideTh = document.getElementById('hideTh');　// 表示/非表示 UI
const hideRom = document.getElementById('hideRom');
const hideJp = document.getElementById('hideJp');
const audioOnly = document.getElementById('audioOnly');
const showAllBtn = document.getElementById('showAll');
const resumeToggle = document.getElementById('resumeToggle');　// === 連続再生の再開設定 ===
const clearResume  = document.getElementById('clearResume');
const contScope = document.getElementById('contScope');　// 連続対象
(function initContScope(){
  const v = localStorage.getItem('contScope') || 'both';
  if (contScope) contScope.value = v;
})();
contScope?.addEventListener('change', ()=>{
  localStorage.setItem('contScope', contScope.value);
  // キュー作り直しは必要な時だけ（ここでは検索と同様に再描画だけでOK）
  doFilter();
});

function loadResumePref(){
  try{ resumeToggle.checked = (localStorage.getItem('resumeEnabled') === '1'); }
  catch(e){ resumeToggle.checked = false; }
}
function saveResumePref(){
  localStorage.setItem('resumeEnabled', resumeToggle.checked ? '1' : '0');
}
resumeToggle?.addEventListener('change', saveResumePref);
loadResumePref();

// 保存する最終位置 {id, mode, level, query}
function saveLastPosition(){
  const state = {
    id: currentId || null,
    mode: seqMode?.value || 'all',
    level: (typeof levelFilter!=='undefined' && levelFilter) ? (levelFilter.value||'') : '',
    query: q?.value || ''
  };
  localStorage.setItem('contState', JSON.stringify(state));
}
function getLastPosition(){
  try{ return JSON.parse(localStorage.getItem('contState')||'{}'); }
  catch(e){ return {}; }
}
clearResume?.addEventListener('click', ()=>{
  localStorage.removeItem('contState');
  alert('保存した再生位置をクリアしました。');
});

/* ===== 表示/非表示：保存/復元 ===== */
function saveVisPrefs(){
  const o = {
    th: !!hideTh.checked,
    rom: !!hideRom.checked,
    jp: !!hideJp.checked,
    audio: !!audioOnly.checked
  };
  localStorage.setItem('visPrefs', JSON.stringify(o));
}
function loadVisPrefs(){
  try{
    const o = JSON.parse(localStorage.getItem('visPrefs')||'{}');
    hideTh.checked = !!o.th;
    hideRom.checked = !!o.rom;
    hideJp.checked = !!o.jp;
    audioOnly.checked = !!o.audio;
  }catch(e){}
}
loadVisPrefs();

/* ===== 表示/非表示：適用 ===== */
function applyVisibility(){
  // audioOnly のときはすべて隠す
  const audio = audioOnly.checked;
  const thH = audio || hideTh.checked;
  const romH = audio || hideRom.checked;
  const jpH = audio || hideJp.checked;

  // 単語 & フレーズ両方に適用
  document.querySelectorAll('#list .card, #phraseList .card').forEach(card=>{
    const thEl  = card.querySelector('.th');
    const romEl = card.querySelector('.rom');
    const jpEl  = card.querySelector('.jp');
    thEl  && thEl.classList.toggle('hidden', thH);
    romEl && romEl.classList.toggle('hidden', romH);
    jpEl  && jpEl.classList.toggle('hidden', jpH);
  });

  // UIの有効/無効（任意）：audioOnly中は他チェック無効化
  [hideTh, hideRom, hideJp].forEach(cb => cb.disabled = audio);
}

/* ===== イベント ===== */
[hideTh, hideRom, hideJp, audioOnly].forEach(el=>{
  el.addEventListener('change', ()=>{ saveVisPrefs(); applyVisibility(); });
});
showAllBtn.addEventListener('click', ()=>{
  hideTh.checked = hideRom.checked = hideJp.checked = false;
  audioOnly.checked = false;
  saveVisPrefs(); applyVisibility();
});

// 初回適用
applyVisibility();

let currentId=null, isContinuous=false, queue=[], queueIndex=-1, speaking=false;

/* ===== 速度 ===== */
function roundRate(x){ const v=Math.round(x*10)/10; return Math.min(2.0, Math.max(0.5, v)); }
function applyRate(v){ const r=roundRate(v); player.playbackRate=r; rate.value=r.toFixed(1); rateLabel.textContent=r.toFixed(1)+'×'; localStorage.setItem('playerRate', r.toFixed(1)); }
(function initRate(){ const saved=parseFloat(localStorage.getItem('playerRate')||'1.0'); applyRate(saved); })();
rate.addEventListener('input', e=>applyRate(parseFloat(e.target.value)));
minusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)-0.1));
plusBtn.addEventListener('click', ()=>applyRate(parseFloat(rate.value)+0.1));

/* ===== お気に入り ===== */
function getFavs(){ try {return JSON.parse(localStorage.getItem('favs')||'[]')} catch(e){return []} }
function setFavs(a){ localStorage.setItem('favs', JSON.stringify(a)); }
function isFav(id){ return getFavs().includes(id); }
function toggleFav(id){ const a=getFavs(); const i=a.indexOf(id); if(i>=0) a.splice(i,1); else a.push(id); setFavs(a); }

/* ===== A-B（語ごと保存。ファイル再生のみ有効） ===== */
function loadABMap(){ try {return JSON.parse(localStorage.getItem('abMap')||'{}')} catch(e){return {}} }
function saveABMap(m){ localStorage.setItem('abMap', JSON.stringify(m)); }
function getAB(id){ const m=loadABMap(); return m[id]||{a:null,b:null,enabled:false}; }
function setAB(id,o){ const m=loadABMap(); m[id]=o; saveABMap(m); }

/* ===== 描画 ===== */
function secondsToMMSS(sec){ if(!isFinite(sec)) return '–:––'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return m+':'+String(s).padStart(2,'0'); }
function render(items){
  list.innerHTML='';
  items.forEach(item=>{
    const card=document.createElement('div'); card.className='card'; card.dataset.id=item.id;

    const head=document.createElement('div'); head.className='head';
    const L=document.createElement('div'); L.className='th';
    const fav=document.createElement('button'); fav.className='fav'; const on=isFav(item.id);
    fav.setAttribute('aria-pressed', on?'true':'false'); fav.textContent=on?'★':'☆';
    fav.addEventListener('click', ()=>{ toggleFav(item.id); const n=isFav(item.id); fav.setAttribute('aria-pressed', n?'true':'false'); fav.textContent=n?'★':'☆'; if(isContinuous && seqMode.value==='favs') buildQueue(); });
    const thText=document.createElement('span'); thText.textContent=item.th;
    L.appendChild(fav); L.appendChild(thText);

    const R=document.createElement('div');
    const playBtn=document.createElement('button'); playBtn.textContent='▶ 再生';
    playBtn.addEventListener('click', ()=>userStart(item));
    R.appendChild(playBtn);

    head.appendChild(L); head.appendChild(R);

    const rom=document.createElement('div'); rom.className='rom'; rom.textContent=item.rom;
    const jp=document.createElement('div'); jp.className='jp'; jp.textContent=item.jp;

    const progWrap=document.createElement('div'); progWrap.className='progress-wrap';
    const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('div'); bar.className='bar'; prog.appendChild(bar);
    const timeLabel=document.createElement('span'); timeLabel.className='small muted'; timeLabel.textContent='0:00';
    progWrap.appendChild(prog); progWrap.appendChild(timeLabel);

    card.appendChild(head); card.appendChild(rom); card.appendChild(jp); card.appendChild(progWrap);
    list.appendChild(card);

    item._els={ playBtn, thText, progWrap, bar, timeLabel };
  });
  updateNowPlayingStyle();
}

// --- Thai 分割ヘルパー（Intl.Segmenter があれば使う）---
function tokenizeThaiForClickable(text){
  try{
    if (typeof Intl !== 'undefined' && Intl.Segmenter){
      const seg = new Intl.Segmenter('th', { granularity: 'word' });
      const out = [];
      for (const s of seg.segment(text)){
        out.push({ text: s.segment, clickable: !!s.isWordLike });
      }
      return out;
    }
  }catch(e){}
  // フォールバック：空白・句読点・記号で分割（簡易）
  const parts = text.split(/(\s+|[.,;:!?、。！？「」『』()（）【】［］…—\-–])/);
  return parts.filter(Boolean).map(t => ({
    text: t,
    clickable: !/\s+|[.,;:!?、。！？「」『』()（）【】［］…—\-–]/.test(t)
  }));
}

// フレーズ描画：タイ語を語単位に分割してクリック検索OK
function renderPhrases(items){
  phraseList.innerHTML = '';
  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = p.id;

    const head = document.createElement('div');
    head.className = 'head';

    const L = document.createElement('div');
    L.className = 'th';

    // 語分割して各語にクリックを付与
    const frag = document.createDocumentFragment();
    tokenizeThaiForClickable(p.th || '').forEach(tok=>{
      if (!tok.clickable){
        frag.appendChild(document.createTextNode(tok.text));
      } else {
        const span = document.createElement('span');
        span.textContent = tok.text;
        span.style.textDecoration = 'underline';
        span.style.textUnderlineOffset = '3px';
        span.style.cursor = 'pointer';
        span.title = 'この語で検索';
        span.dataset.token = tok.text;               // ← 修正：token ではなく tok.text
        span.addEventListener('click', ()=>{         // ← 直接クリックで検索
          q.value = tok.text;
          doFilter();
          q.focus();
        });
        frag.appendChild(span);
      }
    });
    L.appendChild(frag);

    const R = document.createElement('div');
    const btn = document.createElement('button');
    btn.textContent = '▶ 再生';
    btn.addEventListener('click', ()=> playSequenceFor(p));
    R.appendChild(btn);

    head.appendChild(L); head.appendChild(R);

    const rom = document.createElement('div'); rom.className='rom'; rom.textContent = p.rom || '';
    const jp  = document.createElement('div'); jp.className='jp';  jp.textContent  = p.jp  || '';

    card.appendChild(head);
    card.appendChild(rom);
    card.appendChild(jp);
    phraseList.appendChild(card);

    p._els = { playBtn: btn, thText: L };
  });
}

function updateNowPlayingStyle(){
  [...ITEMS, ...PHRASES].forEach(it=>{
    if(!it._els) return;
    it._els.thText.classList.toggle('nowplaying',
      it.id === currentId && (!player.paused || speaking)
    );
  });
}

function updateProgressUI(item){ if(!item||!item._els) return; const {bar,timeLabel}=item._els; const dur=player.duration||0, cur=player.currentTime||0; const pct=dur?Math.min(100, Math.max(0,(cur/dur)*100)):0; bar.style.width=pct+'%'; timeLabel.textContent=secondsToMMSS(cur)+(dur?' / '+secondsToMMSS(dur):''); }
let progressTimer=null;
function startProgress(item){ stopProgress(); progressTimer=setInterval(()=>updateProgressUI(item),200); }
function stopProgress(){ if(progressTimer) clearInterval(progressTimer); progressTimer=null; }

/* ===== シーケンス設定 保存/復元 ===== */
function saveSeqPrefs(){
  const obj={preset:seqPreset.value, custom:seqCustom.value, pause:parseFloat(pauseSec.value)||0.8, pfTh:preferFileTh.checked, pfJp:preferFileJp.checked};
  localStorage.setItem('seqPrefs', JSON.stringify(obj));
}
function loadSeqPrefs(){
  try{
    const o=JSON.parse(localStorage.getItem('seqPrefs')||'{}');
    if(o.preset) seqPreset.value=o.preset;
    if(o.custom) seqCustom.value=o.custom;
    if(o.pause!=null) pauseSec.value=o.pause;
    if(o.pfTh!=null) preferFileTh.checked=o.pfTh;
    if(o.pfJp!=null) preferFileJp.checked=o.pfJp;
  }catch(e){}
}
[seqPreset,seqCustom,pauseSec,preferFileTh,preferFileJp].forEach(el=>el.addEventListener('change', saveSeqPrefs));
loadSeqPrefs();

/* ===== 再生エンジン ===== */
function patternSteps(){
  const v = (seqPreset.value==='custom' ? seqCustom.value : seqPreset.value).trim();
  return v.split(',').map(s=>s.trim()).filter(Boolean); // 'th','jp','pause'
}
function tts(text, lang, rate){
  return new Promise((resolve,reject)=>{
    const u = new SpeechSynthesisUtterance(text);
    const v = pickVoice(lang);     // ← ここで言語に合う声を選ぶ
    if (v) u.voice = v;
    u.lang = v?.lang || lang;      // ヒントとして言語も指定
    u.rate = rate;
    u.onstart = ()=>{ speaking=true; updateNowPlayingStyle(); };
    u.onend   = ()=>{ speaking=false; resolve(); };
    u.onerror = e =>{ speaking=false; reject(e); };
    speechSynthesis.cancel();      // 多重再生防止
    speechSynthesis.speak(u);
  });
}
function playFile(src, ab){ // ab: {enabled,a,b}
  return new Promise((resolve,reject)=>{
    player.src = src;
    const onEnded = ()=>{ cleanup(); resolve(); };
    const onTime = ()=>{
      if(ab && ab.enabled && ab.a!=null && ab.b!=null){
        const eps=0.02; if(player.currentTime >= ab.b-eps){ player.currentTime = ab.a; }
      }
    };
    const onErr = (e)=>{ cleanup(); reject(e); };
    function cleanup(){ player.removeEventListener('ended', onEnded); player.removeEventListener('timeupdate', onTime); player.removeEventListener('error', onErr); stopProgress(); }
    player.play().then(()=>{
      startProgress(ITEMS.find(it=>it.id===currentId));
      player.addEventListener('ended', onEnded);
      player.addEventListener('timeupdate', onTime);
      player.addEventListener('error', onErr);
    }).catch(onErr);
  });
}
function fileUrl(name){ return BASE_URL + name; }

async function playSequenceFor(item){
  saveLastPosition();   // ← ここを追加（連続/単発どちらでも位置を記録）
  currentId = item.id;
  updateNowPlayingStyle();
  setAllButtonsToPlay(); item._els.playBtn.textContent='⏸ 停止';
  np.textContent = 'Now Playing: ' + item.th + ' (' + item.jp + ')';

  const rateVal = parseFloat(localStorage.getItem('playerRate')||'1.0');
  const ab = getAB(item.id); // ファイル再生時のみ使用
  const steps = patternSteps();
  for (let step of steps){
    if(step==='pause'){ await new Promise(r=>setTimeout(r, Math.max(0, (parseFloat(pauseSec.value)||0.8)*1000))); continue; }
    if(step==='th'){
      const useFile = preferFileTh.checked && item.file_th;
      if(useFile){
        // A-B有効（ファイルのみ）
        player.playbackRate = rateVal;
        startProgress(item);
        await playFile(fileUrl(item.file_th), ab.enabled?ab:null).catch(()=>{});
      }else{
        stopProgress();
        await tts(item.th, TTS_LANG_TH, rateVal).catch(()=>{});
      }
    }
    if(step==='jp'){
      const useFile = preferFileJp.checked && item.file_jp;
      if(useFile){
        player.playbackRate = rateVal;
        startProgress(item);
        await playFile(fileUrl(item.file_jp), null).catch(()=>{});
      }else{
        stopProgress();
        await tts(item.jp, TTS_LANG_JP, rateVal).catch(()=>{});
      }
    }
  }
}
function setAllButtonsToPlay(){
  [...ITEMS, ...PHRASES].forEach(it=>{
    if(it._els) it._els.playBtn.textContent = '▶ 再生';
  });
}

async function userStart(item){
  // 連続再生中の位置調整
  if (isContinuous) {
    const ix = queue.findIndex(x => x.id === item.id);
    if (ix >= 0) queueIndex = ix; else { seqMode.value='all'; buildQueue(); queueIndex = queue.findIndex(x => x.id === item.id); }
  }
  // 実行
  await playSequenceFor(item);
  // 1トークン終了後の遷移
  if (!isContinuous) { currentId=null; setAllButtonsToPlay(); updateNowPlayingStyle(); np.textContent=''; return; }
  if (loopOne.checked) { userStart(item); return; }
  queueIndex++; if(queueIndex>=queue.length){ stopContinuous(); return; }
  userStart(queue[queueIndex]);
}

/* ===== 連続再生 ===== */
function currentFilteredItems(){
  const v = q.value.trim().toLowerCase();
  const lv = levelFilter.value;
  return ITEMS.filter(it =>
    (it.th.toLowerCase().includes(v) ||
     it.rom.toLowerCase().includes(v) ||
     it.jp.toLowerCase().includes(v)) &&
    (!lv || (it.lvl && it.lvl.includes(lv)))
  );
}

function currentFilteredPhrases(){
  const v = q.value.trim().toLowerCase();
  const lv = levelFilter.value;

  return PHRASES.filter(p => {
    const hit = (p.th||'').toLowerCase().includes(v) ||
                (p.rom||'').toLowerCase().includes(v) ||
                (p.jp||'').toLowerCase().includes(v);
    const okLevel = !lv || phraseUsesLevel(p, lv);
    return hit && okLevel;
  });
}

function buildQueue(){
  const scope = (contScope?.value) || 'both';

  if (seqMode.value === 'favs'){
    // お気に入りは現状「単語のみ」。級フィルタは適用。
    const fav = new Set(getFavs());
    const lv = levelFilter.value;
    queue = ITEMS.filter(it => fav.has(it.id) && (!lv || (it.lvl && it.lvl.includes(lv))));
    return;
  }

  // 一覧（全体）モード：連続対象の選択に従ってキュー化
  const words   = currentFilteredItems();
  const phrases = currentFilteredPhrases();

  if (scope === 'items') {
    queue = words.slice();
  } else if (scope === 'phrases') {
    queue = phrases.slice();
  } else {
    // both: 単語→フレーズの順で連結（必要ならここで交互にする実装にも変更可）
    queue = words.concat(phrases);
  }
}

function startContinuous(){
  buildQueue();
  if(!queue.length){
    alert(seqMode.value==='favs'?'お気に入りが空です。☆をつけてください。':'再生対象がありません。');
    return;
  }

  // 既定は先頭。チェックONなら保存済みの位置から
  let startIx = 0;
  if (resumeToggle && resumeToggle.checked){
    const st = getLastPosition();
    if (st && st.id){
      // 現在のキューの中で最後に再生したIDを探す（フィルタや級が違って入ってなければ無視）
      const ix = queue.findIndex(x => x.id === st.id);
      if (ix >= 0) startIx = ix;
    }
  }

  isContinuous = true;
  const ixNow = currentId ? queue.findIndex(x=>x.id===currentId) : -1;
  queueIndex = (ixNow>=0 ? ixNow : startIx);

  userStart(queue[queueIndex]);
  seqStart.disabled = true;
  seqMode.disabled  = true;
}

function stopContinuous(){ isContinuous=false; queue=[]; queueIndex=-1; seqStart.disabled=false; seqMode.disabled=false; np.textContent=''; saveLastPosition();  // ← 追加
 }
seqStart.addEventListener('click', startContinuous);
seqStop.addEventListener('click', ()=>{ stopContinuous(); speechSynthesis.cancel(); if(!player.paused){ player.pause(); } });

// 指定級の語（ITEMS）を含むか判定
function phraseUsesLevel(p, lv){
  if (!lv) return true;
  const targets = new Set(ITEMS.filter(it => it.lvl && it.lvl.includes(lv)).map(it => it.th));
  // 簡易：含有チェック（Segmenterがあればより精度UP）
  for (const th of targets){ if ((p.th||'').includes(th)) return true; }
  return false;
}

/* ===== 検索 ===== */
function doFilter(){
  const v = q.value.trim().toLowerCase();
  const lv = levelFilter.value; // "", "k5" など

  const wordFiltered = ITEMS.filter(it => {
    const hit = it.th.toLowerCase().includes(v) ||
                it.rom.toLowerCase().includes(v) ||
                it.jp.toLowerCase().includes(v);
    const okLevel = !lv || (it.lvl && it.lvl.includes(lv));
    return hit && okLevel;
  });
  render(wordFiltered);

  const phraseFiltered = PHRASES.filter(p => {
    const hit = (p.th||'').toLowerCase().includes(v) ||
                (p.rom||'').toLowerCase().includes(v) ||
                (p.jp||'').toLowerCase().includes(v);
    const okLevel = !lv || phraseUsesLevel(p, lv);
    return hit && okLevel;
  });
  renderPhrases(phraseFiltered);
}

q.addEventListener('input', doFilter); clearBtn.addEventListener('click', ()=>{ q.value=''; doFilter(); });
levelFilter.addEventListener('change', doFilter);

/* ===== 初期描画 ===== */
render(ITEMS);
renderPhrases(PHRASES);
applyVisibility();

/* =======================
   自動Day進行 & ストリーク
   ======================= */

// 1) 学習目標（例：7日分）— 必要に応じて増やしてOK
const GOALS = {
  day1: { title:"あいさつ", 
    items:["th-001","th-002","th-003","th-004"],
    phrases:["ph-001","ph-002"] },
  day2: { title:"コア動詞①", 
    items:["core-001","core-002","core-003","core-004","core-005"],
    phrases:["ph-003","ph-004"] },
  day3: { title:"疑問詞①", 
    items:["core-030","core-031","core-032","core-033","core-034"],
    phrases:["ph-011","ph-018","ph-040"] },
  day4: { title:"形容詞①", 
    items:["core-040","core-045","core-046","core-047","core-048"],
    phrases:["ph-010","ph-062","ph-063"] },
  day5: { title:"場所①", 
    items:["core-080","core-081","core-082","core-083","core-084"],
    phrases:["ph-015","ph-016","ph-025"] },
  day6: { title:"数字①(1-10)", 
    items:["core-100","core-101","core-102","core-103","core-104","core-105","core-106","core-107","core-108","core-109"],
    phrases:["ph-028","ph-030"] },
  day7: { title:"時間・曜日①", 
    items:["core-070","core-071","core-072","core-170","core-171","core-172","core-173","core-174","core-175","core-176"],
    phrases:["ph-041","ph-042","ph-044"] },
};
// dayN の最大
const MAX_DAY = Object.keys(GOALS).length;

// 2) 参照
const todayGoalEl = document.getElementById('todayGoal');
const todayMetaEl = document.getElementById('todayMeta');
const streakEl = document.getElementById('streak');
const resetStartBtn = document.getElementById('resetStart');

// 3) 開始日の保存/取得（初回アクセス日を Day1 起点に）
function getTodayKey(d=new Date()){ return d.toISOString().slice(0,10); } // YYYY-MM-DD
function loadStartDate(){
  let s = localStorage.getItem('startDate');
  if(!s){ s = getTodayKey(); localStorage.setItem('startDate', s); }
  return s; // "YYYY-MM-DD"
}
function setStartDateToday(){
  localStorage.setItem('startDate', getTodayKey());
}

// 4) 今日が何日目か（1始まり）
function getDayNumber(){
  const start = new Date(loadStartDate());
  const today = new Date(getTodayKey());
  const diffDays = Math.floor((today - start)/(1000*60*60*24));
  return Math.max(1, Math.min(MAX_DAY, diffDays + 1));
}

// 5) 進捗の保存
function loadProgress(){ return JSON.parse(localStorage.getItem('progressByDate')||'{}'); }
function saveProgress(p){ localStorage.setItem('progressByDate', JSON.stringify(p)); }

// 6) 今日の目標を描画（チェック保存つき）
function renderTodayGoal(){
  const n = getDayNumber();
  const key = 'day'+n;
  const goal = GOALS[key] || GOALS['day'+MAX_DAY];
  todayGoalEl.innerHTML = '';
  if(!goal){ todayGoalEl.textContent = '今日は目標未設定'; return; }

  // メタ
  const total = (goal.items?.length||0) + (goal.phrases?.length||0);
  todayMetaEl.textContent = `Day${n} / 目標: ${total}項目（${goal.title}）`;

  const prog = loadProgress();
  const dayKey = getTodayKey(); // 日付単位に保存
  prog[dayKey] = prog[dayKey] || { done:false, day:n };

  // セクション（単語）
  if(goal.items?.length){
    const sec = document.createElement('div'); sec.className='card';
    const h = document.createElement('div'); h.className='head';
    h.innerHTML = `<div class="th">単語</div>`;
    sec.appendChild(h);
    const ul = document.createElement('ul'); ul.style.margin='0'; ul.style.paddingLeft='1em';
    goal.items.forEach(id=>{
      const it = ITEMS.find(x=>x.id===id);
      if(!it) return;
      const li = document.createElement('li');
      const chk = document.createElement('input'); chk.type='checkbox';
      chk.checked = !!prog[dayKey][id];
      chk.addEventListener('change', ()=>{
        const pp = loadProgress();
        pp[dayKey] = pp[dayKey] || {done:false, day:n};
        pp[dayKey][id] = chk.checked;
        // 全チェック完了判定
        const allIds = [...(goal.items||[]), ...(goal.phrases||[])];
        pp[dayKey].done = allIds.every(x => !!pp[dayKey][x]);
        saveProgress(pp); updateStreak();
      });
      const playBtn = document.createElement('button'); playBtn.textContent='▶ 再生';
      playBtn.style.marginLeft='6px';
      playBtn.addEventListener('click', ()=> userStart(it));
      li.appendChild(chk);
      li.append(` ${it.th}  `);
      const rom = document.createElement('span'); rom.className='rom'; rom.textContent=it.rom?` ${it.rom} `:'';
      const jp  = document.createElement('span'); jp.className='jp';  jp.textContent=it.jp?` ${it.jp} `:'';
      li.appendChild(rom); li.appendChild(jp); li.appendChild(playBtn);
      ul.appendChild(li);
    });
    sec.appendChild(ul);
    todayGoalEl.appendChild(sec);
  }

  // セクション（フレーズ）
  if(goal.phrases?.length){
    const sec = document.createElement('div'); sec.className='card';
    const h = document.createElement('div'); h.className='head';
    h.innerHTML = `<div class="th">フレーズ</div>`;
    sec.appendChild(h);
    const ul = document.createElement('ul'); ul.style.margin='0'; ul.style.paddingLeft='1em';
    goal.phrases.forEach(id=>{
      const ph = PHRASES.find(x=>x.id===id);
      if(!ph) return;
      const li = document.createElement('li');
      const chk = document.createElement('input'); chk.type='checkbox';
      chk.checked = !!prog[dayKey][id];
      chk.addEventListener('change', ()=>{
        const pp = loadProgress();
        pp[dayKey] = pp[dayKey] || {done:false, day:n};
        pp[dayKey][id] = chk.checked;
        const allIds = [...(goal.items||[]), ...(goal.phrases||[])];
        pp[dayKey].done = allIds.every(x => !!pp[dayKey][x]);
        saveProgress(pp); updateStreak();
      });
      const playBtn = document.createElement('button'); playBtn.textContent='▶ 再生';
      playBtn.style.marginLeft='6px';
      playBtn.addEventListener('click', ()=> playSequenceFor(ph));
      li.appendChild(chk);
      // クリックで語検索できるよう簡易表示（th/rom/jpは既存の可視設定が適用されます）
      const th = document.createElement('span'); th.className='th'; th.textContent = ' '+ph.th+' ';
      const rom = document.createElement('span'); rom.className='rom'; rom.textContent = ph.rom?` ${ph.rom} `:'';
      const jp  = document.createElement('span'); jp.className='jp';  jp.textContent = ph.jp?` ${ph.jp} `:'';
      li.appendChild(th); li.appendChild(rom); li.appendChild(jp); li.appendChild(playBtn);
      ul.appendChild(li);
    });
    sec.appendChild(ul);
    todayGoalEl.appendChild(sec);
  }

  // 表示/非表示ルール（音だけ等）を適用
  if (typeof applyVisibility === 'function') applyVisibility();

  updateStreak();
}

// 7) 連続記録（直近から途切れるまで）
function updateStreak(){
  const prog = loadProgress();
  let streak = 0;
  // 今日から日付を一日ずつ遡り、done==true が連続している日数を数える
  const dayMs = 24*60*60*1000;
  let cur = new Date(getTodayKey());
  while(true){
    const key = getTodayKey(cur);
    if (prog[key]?.done) { streak++; cur = new Date(cur - dayMs); }
    else break;
  }
  streakEl.textContent = `連続日数: ${streak}日`;
}

// 8) 開始日を今日にリセット（やり直したい時用）
resetStartBtn.addEventListener('click', ()=>{
  if(confirm('学習開始日を本日に更新します。よろしいですか？（ストリークは保存された実績で再計算されます）')){
    setStartDateToday();
    renderTodayGoal();
  }
});

// 初期呼び出し
loadStartDate();
renderTodayGoal();
window.addEventListener('beforeunload', ()=>{ try{ saveLastPosition(); }catch(e){} });
  
</script>
</body>
</html>
